<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Komunitas</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
  --bg:#0b141a;
  --card:#202c33;
  --me:#005c4b;
  --other:#1f2c33;
  --accent:#00a884;
  --text:#e9edef;
}
*{box-sizing:border-box;font-family:system-ui}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text)}

.screen{height:100%;display:flex;justify-content:center;align-items:center}
.card{width:90%;max-width:420px;background:var(--card);padding:24px;border-radius:20px}

input,select,button{
  width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px
}
input,select{background:#0b141a;color:#fff}
button{background:var(--accent);color:#fff;font-weight:600}

#searching{
  display:none;
  flex-direction:column;
  align-items:center;
  gap:12px;
}
.loader{
  width:36px;height:36px;
  border:4px solid #2a3942;
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

#chat{display:none;height:100%;flex-direction:column}
.header{
  height:56px;background:var(--card);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;
}
.icons i{font-size:20px;margin-left:14px;cursor:pointer}

#messages{flex:1;padding:12px;overflow-y:auto}
.msg{max-width:78%;margin-bottom:8px;font-size:14px}
.me{margin-left:auto}
.bubble{padding:8px 12px;border-radius:8px}
.me .bubble{background:var(--me);border-top-right-radius:0}
.other .bubble{background:var(--other);border-top-left-radius:0}
.time{font-size:10px;opacity:.5;text-align:right;margin-top:2px}
.footer{padding:8px;background:var(--card);display:flex;gap:6px}
.footer input{flex:1;border-radius:20px}
.footer button{width:44px;border-radius:50%}

#profileModal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9
}
#profileBox{
  background:#202c33;
  width:90%;
  max-width:320px;
  padding:20px;
  border-radius:16px
}
.login-header{
  text-align:center;
  animation:fadeUp .6s ease;
}

.login-header .logo{
  font-size:40px;
  margin-bottom:6px;
}

.login-header h1{
  margin:0;
  font-size:22px;
  font-weight:700;
}

.login-header p{
  margin:4px 0 16px;
  font-size:13px;
  opacity:.7;
}

.start-btn{
  width:160px;
  margin:0 auto;
  border-radius:30px;
}

.card{
  margin-top:20px;
  animation:slideUp .4s ease;
}

.hidden{
  display:none;
}

.age-wrap{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  opacity:.8;
  margin-bottom:4px;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:translateY(0)}
}

@keyframes slideUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
.card-header{
  text-align:center;
  margin-bottom:14px;
}
.card-header h2{
  margin:0;
  font-size:18px;
  font-weight:700;
}
.card-header p{
  margin:4px 0 0;
  font-size:12px;
  opacity:.7;
}
#partnerStatus {
  transition: color 0.3s;
  font-style: italic;
}

.status-online {
  color: #25D366; 
  font-weight: bold;
}

.status-offline {
  color: #FF5C5C; 
  font-weight: bold;
}

.status-typing {
  color: #FFD700;
  font-weight: bold;
}

</style>

<div class="screen" id="login">
  <div class="login-header" id="loginHeader">
    <div class="logo">ðŸ’¬</div>
    <h1>Chat Komunitas</h1>
    <p>Ngobrol random dengan orang baru</p>

    <button class="start-btn" onclick="showForm()">
      Mulai
    </button>
  </div>

<div class="card hidden" id="loginForm">
  <div class="card-header">
    <h2>Sanz Project</h2>
    <p>Isi data singkat sebelum mulai chat</p>
  </div>

  <input id="name" placeholder="Nama">

  <div class="age-wrap">
    <span>Umur</span>
    <span id="ageVal">21</span>
  </div>
  <input id="age" type="range" min="16" max="30" value="21"
    oninput="ageVal.innerText=this.value">

  <select id="gender">
    <option value="" disabled selected>Gender</option>
    <option>Laki-laki</option>
    <option>Perempuan</option>
  </select>

  <select id="job">
    <option value="" disabled selected>Status</option>
    <option>Sekolah</option>
    <option>Kerja</option>
    <option>Pengangguran</option>
  </select>

  <select id="server">
    <option value="server1">Server 1</option>
    <option value="server2">Server 2</option>
    <option value="server3">Server 3</option>
  </select>

  <button onclick="start()">Masuk Chat</button>
  
  </div>
</div>

<div class="screen" id="searching">
  <div class="loader"></div>
  <div>Mencari partner...</div>
</div>

<div id="chat">
  <div class="header">
  <div>
    <div id="partnerName">Chat</div>
    <div id="partnerStatus" style="font-size:12px;opacity:0.6;height:14px;">Online</div>
  </div>
  <div class="icons">
    <i class="bi bi-person-circle" onclick="openProfile()"></i>
    <i class="bi bi-box-arrow-right" onclick="logout()"></i>
  </div>
</div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Pesan..."
      onkeydown="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">âž¤</button>
  </div>
</div>

<div id="profileModal">
  <div id="profileBox">
    <h3>Profil Partner</h3>
    <div id="profileContent"></div>
    <br>
    <button onclick="closeProfile()">Tutup</button>
  </div>
</div>

<script>
const socket = io("https://chat-jsb8.onrender.com");
let partner = null;

function start(){
  const username = document.getElementById("name").value.trim();
  const userAge  = document.getElementById("age").value;
  const userGender = document.getElementById("gender").value;
  const userJob = document.getElementById("job").value;
  const userServer = document.getElementById("server").value;

  socket.emit("join",{
    name: username !== "" ? username : "Anonim",
    age: userAge,
    gender: userGender,
    job: userJob,
    server: userServer
  });

  login.style.display="none";
  searching.style.display="flex";
}

function showForm(){
  document.getElementById("loginHeader").style.display = "none";
  document.getElementById("loginForm").classList.remove("hidden");
}

function setStatus(status){
  partnerStatus.innerText = status;
  partnerStatus.classList.remove("status-online","status-offline","status-typing");
  if(status === "Online") partnerStatus.classList.add("status-online");
  else if(status === "Offline") partnerStatus.classList.add("status-offline");
  else if(status === "Sedang mengetikâ€¦") partnerStatus.classList.add("status-typing");
}

socket.on("matched", p => {
  partner = p;
  searching.style.display = "none";
  chat.style.display = "flex";
  messages.innerHTML = "";
  partnerName.innerText = p.name;
  setStatus("Online"); // set status awal
});

socket.on("message",m=>{
  addMsg(m.text,"other",m.time);
});

msg.addEventListener("input", () => {
  socket.emit("typing");
});

socket.on("typing", () => {
  setStatus("Sedang mengetikâ€¦");
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(() => {
    setStatus("Online");
  }, 2000);
});

socket.on("typing", () => {
  if(socket.partner) {
    socket.partner.emit("typing");
  }
});

socket.on("partner-left", () => {
  setStatus("Offline");
});

socket.on("disconnect", () => {
  if(socket.partner){
    socket.partner.emit("partner-left");
  }
});

function sendMessage(){
  if(!msg.value||!partner)return;
  socket.emit("message",msg.value);
  addMsg(msg.value,"me",timeNow());
  msg.value="";
}

function openProfile(){
  if(!partner)return;
  profileContent.innerHTML=`
    <b>Nama:</b> ${partner.name}<br>
    <b>Umur:</b> ${partner.age}<br>
    <b>Gender:</b> ${partner.gender||"-"}<br>
    <b>Status:</b> ${partner.job||"-"}<br>
    <b>Server:</b> ${partner.server}
  `;
  profileModal.style.display="flex";
}
function closeProfile(){profileModal.style.display="none";}

function addMsg(t,s,ti){
  messages.innerHTML+=`
  <div class="msg ${s}">
    <div class="bubble">${t}</div>
    <div class="time">${ti}</div>
  </div>`;
  messages.scrollTop=messages.scrollHeight;
}
function timeNow(){
  const d=new Date();
  return d.getHours().toString().padStart(2,"0")+":"+
         d.getMinutes().toString().padStart(2,"0");
}
function logout(){location.reload();}
</script>
</body>
</html>
