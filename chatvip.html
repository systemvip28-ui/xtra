<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Komunitas</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style> :root{ --bg:#0b141a; --card:#202c33; --me:#005c4b; --other:#1f2c33; --accent:#00a884; --text:#e9edef; } *{box-sizing:border-box;font-family:system-ui} html,body{margin:0;height:100%;background:var(--bg);color:var(--text)} .screen{height:100%;display:flex;justify-content:center;align-items:center} .card{width:90%;max-width:420px;background:var(--card);padding:24px;border-radius:20px} input,select,button{ width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px } input,select{background:#0b141a;color:#fff} button{background:var(--accent);color:#fff;font-weight:600} #searching{ display:none; flex-direction:column; align-items:center; gap:12px; } .loader{ width:36px;height:36px; border:4px solid #2a3942; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; } @keyframes spin{to{transform:rotate(360deg)}} #chat{display:none;height:100%;flex-direction:column} .header{ height:56px;background:var(--card); display:flex;align-items:center;justify-content:space-between; padding:0 14px; } .icons i{font-size:20px;margin-left:14px;cursor:pointer} #messages{flex:1;padding:12px;overflow-y:auto} .msg{max-width:78%;margin-bottom:8px;font-size:14px} .me{margin-left:auto} .bubble{padding:8px 12px;border-radius:8px} .me .bubble{background:var(--me);border-top-right-radius:0} .other .bubble{background:var(--other);border-top-left-radius:0} .time{font-size:10px;opacity:.5;text-align:right;margin-top:2px} .footer{padding:8px;background:var(--card);display:flex;gap:6px} .footer input{flex:1;border-radius:20px} .footer button{width:44px;border-radius:50%} #profileModal{ position:fixed;inset:0; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:9 } #profileBox{ background:#202c33; width:90%; max-width:320px; padding:20px; border-radius:16px } .login-header{ text-align:center; animation:fadeUp .6s ease; } .login-header .logo{ font-size:40px; margin-bottom:6px; } .login-header h1{ margin:0; font-size:22px; font-weight:700; } .login-header p{ margin:4px 0 16px; font-size:13px; opacity:.7; } .start-btn{ width:160px; margin:0 auto; border-radius:30px; } .card{ margin-top:20px; animation:slideUp .4s ease; } .hidden{ display:none; } .age-wrap{ display:flex; justify-content:space-between; font-weight: bold; font-size:14px; opacity:.8; margin-top:10px; } @keyframes fadeUp{ from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} } @keyframes slideUp{ from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} } .card-header{ text-align:center; margin-bottom:14px; } .card-header h2{ margin:0; font-size:18px; font-weight:700; } .card-header p{ margin:4px 0 0; font-size:12px; opacity:.7; } #partnerStatus { transition: color 0.3s; font-style: italic; } .status-online { color: #25D366; font-weight: bold; } .status-offline { color: #FF4D4D; font-weight: bold; } .status-typing { color: #FFD700; font-weight: bold; } </style>
<style>
.video-wrap{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  z-index:30;
}

#localVideo {
  transform: scaleX(1);
}

.video-header{
  height:56px;
  background:#0b141a;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  font-weight:600;
}

.video-body{
  flex:1;
  position:relative;
  background:#000;
}

.video-body video { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; 
}

.video-body .pip{ 
  position:absolute; bottom:12px; 
  right:12px; 
  width:110px; 
  height:160px; 
  border-radius:12px; 
  border:2px solid #111; 
  background:#000;
}

.pip{
  position:absolute;
  bottom:12px;
  right:12px;
  width:120px;
  height:170px;
  border-radius:12px;
  cursor:move;
  z-index:10;
}

.video-footer{
  height:72px;
  background:#0b141a;
  display:flex;
  justify-content:space-evenly;
  align-items:center;
}

.video-footer i{
  font-size:24px;
  padding:14px;
  border-radius:50%;
  background:#202c33;
}

.video-footer .end{
  background:#ff4d4d;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 50;
}

.modal-box {
  background: #202c33;
  padding: 20px;
  border-radius: 16px;
  width: 80%;
  max-width: 300px;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.reject-box h3 {
  color: #ff4d4d;
}
.reject-box p {
  font-size: 14px;
  opacity: 0.8;
}
.reject-box button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
}

#waitingModal .modal-box {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

.modal-box button{
  width:100%; margin-top:10px;
}

.net-status{
  position:absolute;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  gap:10px;
  display:none; 
  background:#202c33cc;
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
}
</style>
<div class="screen" id="login">
  <div class="login-header" id="loginHeader">
    <div class="logo">ðŸ’¬</div>
    <h1>Chat Komunitas</h1>
    <p>Ngobrol random dengan orang baru</p>

    <button class="start-btn" onclick="showForm()">
      Mulai
    </button>
  </div>

<div class="card hidden" id="loginForm">
  <div class="card-header">
    <h2>Sanz Project</h2>
    <p>Isi data singkat sebelum mulai chat</p>
  </div>

  <input id="name" placeholder="Nama">

  <div class="age-wrap">
    <span>Umur</span>
    <span id="ageVal">21</span>
  </div>
  <input id="age" type="range" min="7" max="100" value="21"
    oninput="ageVal.innerText=this.value">

  <select id="gender">
    <option value="" disabled selected>Gender</option>
    <option>Laki-laki</option>
    <option>Perempuan</option>
  </select>

  <select id="job">
    <option value="" disabled selected>Status</option>
    <option>Sekolah</option>
    <option>Kerja</option>
    <option>Pengangguran</option>
  </select>

  <select id="server">
    <option value="server1">Server 1</option>
    <option value="server2">Server 2</option>
    <option value="server3">Server 3</option>
  </select>

  <button onclick="start()">Masuk Chat</button>
  
  </div>
</div>

<div class="screen" id="searching">
  <div class="loader"></div>
  <div>Mencari partner...</div>
</div>

<div id="chat">
  <div class="header">
  <div>
    <div id="partnerName">Chat</div>
    <div id="partnerStatus" style="font-size:12px;opacity:0.6;height:14px;">Online</div>
  </div>
<div class="icons">
  <i class="bi bi-arrow-clockwise" id="refreshBtn" onclick="refreshChat()" style="display:none"></i>
  <i class="bi bi-camera-video-fill" onclick="callUser()" id="videoCallBtn"></i>
  <i class="bi bi-person-circle" onclick="openProfile()"></i>
  <i class="bi bi-box-arrow-right" onclick="logout()"></i>
</div>
</div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Pesan..."
      onkeydown="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">âž¤</button>
  </div>
</div>

<div id="videoScreen" class="video-wrap">
  <div class="video-header">
    <span id="callName">Video Call</span>
    <span id="signalStatus" style="font-size:12px; opacity:0.8;">ðŸŸ¢ Stabil</span>
  </div>

  <div class="video-body">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline class="pip"></video>
  </div>

  <div class="video-footer">
    <i id="micBtn" class="bi bi-mic-fill" onclick="toggleMic()"></i>
    <i id="camBtn" class="bi bi-camera-video-fill" onclick="toggleCam()"></i>
    <i class="bi bi-arrow-repeat" onclick="switchCamera()"></i>
    <i class="bi bi-telephone-x-fill end" onclick="endCall()"></i>
  </div>
</div>

<div id="incomingCall" class="modal">
  <div class="modal-box">
    <h3>Panggilan Masuk</h3>
    <p id="callerName"></p>
    <button onclick="acceptCall()">Terima</button>
    <button onclick="rejectCall()" style="background:#ff4d4d">Tolak</button>
  </div>
</div>

<div id="rejectedModal" class="modal">
  <div class="modal-box">
    <div class="modal-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </div>
    <p id="rejectedText"></p>
    <button onclick="closeRejected()">Tutup</button>
  </div>
</div>

<div id="profileModal">
  <div id="profileBox">
    <h3>Profil Partner</h3>
    <div id="profileContent"></div>
    <br>
    <button onclick="closeProfile()">Tutup</button>
  </div>
</div>

<div class="net-status">
  <span id="netLeft">Stabil</span>
  <span id="signalDot">ðŸŸ¢</span>
  <span id="netRight">HD</span>
</div>

<div id="waitingModal" class="modal">
  <div class="modal-box">
    <div class="loader"></div>
    <p id="waitingText">Menunggu partner menerima panggilan...</p>
  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box">
    <p id="alertText" style="font-size:14px;"></p>
    <button onclick="closeAlert()">Tutup</button>
  </div>
</div>

<script>
// ================== SOCKET CHAT ==================
const socket = io("https://chat-jsb8.onrender.com");
let partner = null;

function start() {
  const username = document.getElementById("name").value.trim();
  const userAge = document.getElementById("age").value;
  const userGender = document.getElementById("gender").value;
  const userJob = document.getElementById("job").value;
  const userServer = document.getElementById("server").value;

  socket.emit("join", {
    name: username || "Anonim",
    age: userAge,
    gender: userGender,
    job: userJob,
    server: userServer
  });

  login.style.display = "none";
  searching.style.display = "flex";
}

function showAlert(text) {
  alertText.innerText = text;
  alertModal.style.display = "flex";
}

function closeAlert() {
  alertModal.style.display = "none";
}

function showForm() {
  document.getElementById("loginHeader").style.display = "none";
  document.getElementById("loginForm").classList.remove("hidden");
}

function setStatus(status) {
  partnerStatus.innerText = status;
  partnerStatus.classList.remove("status-online", "status-offline", "status-typing");
  if (status === "Online") partnerStatus.classList.add("status-online");
  else if (status === "Offline") partnerStatus.classList.add("status-offline");
  else if (status === "Sedang mengetikâ€¦") partnerStatus.classList.add("status-typing");
}

socket.on("matched", p => {
  partner = p;
  searching.style.display = "none";
  chat.style.display = "flex";
  messages.innerHTML = "";
  partnerName.innerText = p.name;
  setStatus("Online");
  enableChat();
  refreshBtn.style.display = "none";
});

socket.on("message", m => {
  addMsg(m.text, "other", timeNow());
});

msg.addEventListener("input", () => {
  socket.emit("typing");
});
socket.on("typing", () => {
  setStatus("Sedang mengetikâ€¦");
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(() => setStatus("Online"), 2000);
});

socket.on("partner-left", () => {
  setStatus("Offline");
  disableChat();
  refreshBtn.style.display = "inline-block";
});

function refreshChat() {
  messages.innerHTML = "";
  chat.style.display = "none";
  searching.style.display = "flex";
  enableChat();
  setStatus("Online");

  socket.emit("join", {
    name: document.getElementById("name").value || "Anonim",
    age: document.getElementById("age").value,
    gender: document.getElementById("gender").value,
    job: document.getElementById("job").value,
    server: document.getElementById("server").value
  });

  refreshBtn.style.display = "none";
}

function disableChat() {
  msg.disabled = true;
  document.querySelector(".footer button").disabled = true;
}

function enableChat() {
  msg.disabled = false;
  document.querySelector(".footer button").disabled = false;
}

function logout() {
  disableChat();
  setStatus("Offline");
  refreshBtn.style.display = "inline-block";
  chat.style.display = "none";
  searching.style.display = "none";
  login.style.display = "flex";
  partner = null;
  msg.value = "";
  location.reload();
}

function sendMessage() {
  if (!msg.value || !partner) return;
  socket.emit("message", msg.value);
  addMsg(msg.value, "me", timeNow());
  msg.value = "";
}

function openProfile() {
  if (!partner) return;
  profileContent.innerHTML = `
    <b>Nama:</b> ${partner.name}<br>
    <b>Umur:</b> ${partner.age}<br>
    <b>Gender:</b> ${partner.gender || "-"}<br>
    <b>Status:</b> ${partner.job || "-"}<br>
    <b>Server:</b> ${partner.server}
  `;
  profileModal.style.display = "flex";
}

function closeProfile() { profileModal.style.display = "none"; }

function addMsg(t, s, ti) {
  messages.innerHTML += `
    <div class="msg ${s}">
      <div class="bubble">${t}</div>
      <div class="time">${ti}</div>
    </div>`;
  messages.scrollTop = messages.scrollHeight;
}

function timeNow() {
  const d = new Date();
  return d.getHours().toString().padStart(2, "0") + ":" +
         d.getMinutes().toString().padStart(2, "0");
}

// ================== VIDEO CALL ==================
let pc, localStream, isFront = true;
const ice = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let callPending = false;
let isLocalBig = false;

function swapVideo() {
  const remote = document.getElementById("remoteVideo");
  const local = document.getElementById("localVideo");

  if (isLocalBig) {
    remote.classList.remove("pip");
    local.classList.add("pip");
  } else {
    local.classList.remove("pip");
    remote.classList.add("pip");
  }
  isLocalBig = !isLocalBig;
}
localVideo.addEventListener("click", swapVideo);
remoteVideo.addEventListener("click", swapVideo);

function dragElement(el) {
  let x = 0, y = 0, px = 0, py = 0;
  el.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e.preventDefault();
    px = e.clientX;
    py = e.clientY;
    document.onmouseup = closeDrag;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e.preventDefault();
    x = px - e.clientX;
    y = py - e.clientY;
    px = e.clientX;
    py = e.clientY;

    el.style.top = (el.offsetTop - y) + "px";
    el.style.left = (el.offsetLeft - x) + "px";
    el.style.bottom = "auto";
    el.style.right = "auto";
  }

  function closeDrag() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
dragElement(localVideo);
dragElement(remoteVideo);

function callUser() {
  if (!partner || callPending) return;
  callPending = true;

  waitingModal.style.display = "flex";
  waitingText.innerText = `Menunggu ${partner.name} menerima panggilan...`;
  callName.innerText = partner.name; 

  socket.emit("call-user", { name: partner.name });

  window.callTimeout = setTimeout(() => {
    waitingModal.style.display = "none";  
    callPending = false;
    showAlert(`${partner.name} tidak menjawab panggilan`);

    if (partner) socket.emit("cancel-call", { to: partner.name });
  }, 30000);
}

socket.on("cancel-call", () => {
  if (incomingCall.style.display === "flex") {
    incomingCall.style.display = "none";
  }
});

socket.on("incoming-call", data => {
  callerName.innerText = data.name;
  callName.innerText = data.name; 
  incomingCall.style.display = "flex";
});

async function acceptCall() {
  incomingCall.style.display = "none";
  await startMedia();
  createPeer();
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  socket.emit("accept-call");
  videoScreen.style.display = "flex";
}

function createPeer() {
  if (pc) return;
  pc = new RTCPeerConnection(ice);

  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.style.transform = "scaleX(1)"; 
    videoScreen.style.display = "flex";
  };

  pc.onicecandidate = e => {
    if (e.candidate) socket.emit("ice", e.candidate);
  };

  pc.onconnectionstatechange = checkSignal;
}

socket.on("call-accepted", async () => {
  clearTimeout(window.callTimeout);
  waitingModal.style.display = "none";
  callPending = false;

  await startMedia();
  createPeer();
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("offer", offer);

  videoScreen.style.display = "flex";
});

socket.on("offer", async offer => {
  if (!pc) createPeer();
  await pc.setRemoteDescription(offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async answer => {
  await pc.setRemoteDescription(answer);
});

socket.on("ice", async candidate => {
  if (candidate && pc) await pc.addIceCandidate(candidate);
});

function rejectCall() {
  incomingCall.style.display = "none";
  socket.emit("reject-call");
}

socket.on("call-rejected", () => {
  clearTimeout(window.callTimeout);
  waitingModal.style.display = "none";
  callPending = false;

  rejectedText.innerText = `${partner ? partner.name : 'Partner'} menolak panggilan.`;
  rejectedModal.style.display = "flex";
});

function closeRejected() {
  rejectedModal.style.display = "none";
}

socket.on("end-call", () => {
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  localStream = null;
  pc = null;
  remoteVideo.srcObject = null;
  videoScreen.style.display = "none";
  document.querySelector(".net-status").style.display = "none";
});

async function startMedia() {
  if (localStream) return;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "user",
        width: { ideal: 480 },  
        height: { ideal: 640 },
        frameRate: { ideal: 30 }
      },
      audio: true
    });

    localVideo.srcObject = localStream;
    localVideo.muted = true;
    localVideo.style.transform = "scaleX(1)"; 
    await localVideo.play();
  } catch (err) {
    showAlert("Kamera / mikrofon tidak diizinkan");
    console.error(err);
  }
}

function toggleMic() {
  if (!localStream) return;
  const t = localStream.getAudioTracks()[0];
  t.enabled = !t.enabled;
  micBtn.className = t.enabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill";
  socket.emit("media-status", { mic: t.enabled });
}

function toggleCam() {
  if (!localStream) return;
  const t = localStream.getVideoTracks()[0];
  t.enabled = !t.enabled;
  camBtn.className = t.enabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill";
  socket.emit("media-status", { cam: t.enabled });
}

async function switchCamera() {
  if (!localStream) return;
  
  isFront = !isFront;

  localStream.getTracks().forEach(t => t.stop());

  localStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: isFront ? "user" : "environment", width: {ideal:480}, height: {ideal:640}, frameRate: {ideal:30} },
    audio: true
  });

  localVideo.srcObject = localStream;
  localVideo.muted = true;
  await localVideo.play();

  if (pc) {
    const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
    if (sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
  }
}

function endCall() {
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  localStream = null;
  pc = null;
  remoteVideo.srcObject = null;
  videoScreen.style.display = "none";
  socket.emit("end-call");
}

function checkSignal() {
  const s = pc.connectionState;
  if (s === "connected") {
    signalDot.textContent = "ðŸŸ¢";
    netLeft.textContent = "Stabil";
    signalStatus.textContent = "ðŸŸ¢ Stabil"; 
  }
  if (s === "disconnected") {
    signalDot.textContent = "ðŸŸ¡";
    netLeft.textContent = "Lemah";
    signalStatus.textContent = "ðŸŸ¡ Lemah"; 
  }
  if (s === "failed") {
    signalDot.textContent = "ðŸ”´";
    netLeft.textContent = "Terputus";
    signalStatus.textContent = "ðŸ”´ Terputus";
  }
}
</script>
</body>
</html>
