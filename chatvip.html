<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sanz</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style> :root { --bg: #0d1117; --surface: #161b22; --surface-2: #1f2937; --accent: #10b981; --accent-dark:#059669; --danger: #ef4444; --warning: #f59e0b; --success: #10b981; --text: #e2e8f0; --text-sec: #94a3b8; --border: #30363d; --me: #065f46; --other: #1e293b; } * { margin: 0; padding: 0; box-sizing: border-box; } html, body { height: 100%; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; } .screen { height: 100dvh; display: grid; place-items: center; padding: 16px; } .card { width: 100%; max-width: 420px; background: var(--surface); border-radius: 20px; border: 1px solid var(--border); padding: 28px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); } .logo-big { font-size: 3.8rem; margin-bottom: 0.5rem; text-align: center; } h1, h2, h3 { text-align: center; } h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; } h2 { margin-bottom: 1.5rem; } .subtitle { color: var(--text-sec); text-align: center; font-size: 0.95rem; margin-bottom: 1.8rem; } input, select, button { width: 100%; padding: 14px 16px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface-2); color: white; font-size: 1rem; } input::placeholder, select option:disabled { color: #64748b; } button { background: var(--accent); color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; } button:hover { background: var(--accent-dark); transform: translateY(-1px); } button:active { transform: translateY(0); } .btn-danger { background: var(--danger); } .btn-danger:hover { background: #dc2626; } .view-once-wrapper, .normal-image-wrapper { cursor: pointer; } .normal-image-wrapper img { transition: transform 0.2s; } .normal-image-wrapper:hover img { transform: scale(1.03); } .view-once-wrapper { position: relative; cursor: pointer; user-select: none; border-radius: 12px; overflow: hidden; background: #0f172a; aspect-ratio: 3/4; max-width: 260px; margin: 4px 0; } .view-once-blur { position: absolute; inset: 0; background: rgba(15,23,42,0.92); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 1.4rem; gap: 8px; z-index: 2; transition: opacity 0.3s; } .view-once-blur.hidden { opacity: 0; pointer-events: none; } .view-once-icon { font-size: 2.8rem; color: var(--text-sec); } .view-once-text { font-size: 0.9rem; opacity: 0.9; text-align: center; max-width: 80%; } #viewOnceModal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 400; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 16px; } .vo-header { width: 100%; max-width: 420px; color: white; font-size: 1.1rem; font-weight: 600; padding: 12px 16px; background: rgba(30,41,59,0.6); border-radius: 12px 12px 0 0; text-align: center; backdrop-filter: blur(8px); } .vo-content { position: relative; max-width: 90vw; max-height: 70vh; border-radius: 0 0 12px 12px; overflow: hidden; background: #000; } .vo-img { max-width: 100%; max-height: 70vh; object-fit: contain; display: block; } .vo-close-btn { position: absolute; bottom: 20px; max-width: 90vw; left: 50%; transform: translateX(-50%); background: #161b22; color: white; border: none; padding: 12px 28px; font-size: 1rem; font-weight: 500; cursor: pointer; backdrop-filter: blur(6px); box-shadow: 0 4px 15px rgba(0,0,0,0.5); } .vo-close-btn:hover { background: #161b22; } .screen { height: 100dvh; display: flex; justify-content: center; align-items: center; padding: 16px; } .searching-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.8rem; text-align: center; max-width: 320px; width: 100%; } .searching-text { font-size: 1.25rem; font-weight: 500; opacity: 0.95; color: var(--text); } .searching-subtext { font-size: 0.95rem; color: var(--text-sec); line-height: 1.4; margin-top: 0.5rem; } #searching { opacity: 0; transition: opacity 0.4s ease; } #searching[style*="display: flex"], #searching[style*="display:block"] { opacity: 1; } .loader { width: 48px; height: 48px; border: 5px solid #2d3748; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } } #chat { display: none; flex-direction: column; height: 100dvh; } .header { height: 64px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-weight: 500; } .partner-info { line-height: 1.3; } .partner-name { font-size: 1.1rem; font-weight: 600; } .partner-status { font-size: 0.82rem; opacity: 0.8; } .status-online { color: #34d399; } .status-offline { color: #f87171; } .status-typing { color: #fbbf24; font-style: italic; } .encryption-info { display: flex; align-items: center; justify-content: center; background: var(--surface-2); padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; color: var(--text-sec); gap: 6px; } .encryption-info i { font-size: 1rem; color: var(--success); } #messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; } .msg { max-width: 78%; display: flex; flex-direction: column; position: relative; user-select: none; } .me { align-self: flex-end; } .other { align-self: flex-start; } .bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.96rem; line-height: 1.4; word-break: break-word; } .me .bubble { background: var(--me); border-bottom-right-radius: 4px; } .other .bubble { background: var(--other); border-bottom-left-radius: 4px; } .time { font-size: 0.68rem; opacity: 0.6; margin-top: 3px; align-self: flex-end; } .file-preview { max-width: 100%; max-height: 200px; border-radius: 8px; } .view-once { opacity: 0.7; font-style: italic; } .deleted-msg { font-style: italic; color: var(--text-sec); } .footer { padding: 12px 16px; background: var(--surface); border-top: 1px solid var(--border); display: flex; gap: 10px; } .footer input { flex: 1; border-radius: 999px; padding: 12px 20px; border: none; } .footer button { width: 48px; height: 48px; border-radius: 50%; font-size: 1.4rem; display: grid; place-items: center; padding: 0; } .video-wrap { position: fixed; inset: 0; background: black; display: none; flex-direction: column; z-index: 100; } .video-header { height: 56px; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 1.05rem; backdrop-filter: blur(10px); } .video-body { flex: 1; position: relative; background: #000; } video { transform: scaleX(-1) !important; } video { width: 100%; height: 100%; object-fit: cover; transition: all 0.4s ease; } video#localVideo, video#remoteVideo, #localVideo.pip, #localVideo.full, #remoteVideo.pip, #remoteVideo.full { transform: scaleX(-1) !important; } #localVideo.pip, #remoteVideo.pip { position: absolute; bottom: 20px; right: 20px; width: 120px !important; height: 160px !important; border-radius: 16px; border: 3px solid rgba(255,255,255,0.25); box-shadow: 0 8px 25px rgba(0,0,0,0.6); background: black; object-fit: cover; cursor: pointer; z-index: 10; } #localVideo.full, #remoteVideo.full { position: static; width: 100% !important; height: 100% !important; border-radius: 0 !important; border: none !important; box-shadow: none !important; z-index: 5; } #localVideo { transform: scaleX(-1); } .video-footer { height: 80px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; gap: 24px; } .video-footer i { font-size: 1.6rem; width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.08); display: grid; place-items: center; cursor: pointer; transition: all 0.2s; } .video-footer i:hover { background: rgba(255,255,255,0.15); } .video-footer i.muted { color: #fca5a5; background: rgba(239,68,68,0.18); } .video-footer .end-call { background: var(--danger); } .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; place-items: center; z-index: 200; backdrop-filter: blur(4px); } .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 28px; width: 90%; max-width: 360px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); } .modal-box button { margin: 8px 0; } #actionToast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(30,41,59,0.92); color: white; padding: 12px 24px; border-radius: 999px; font-size: 0.95rem; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.4s, transform 0.4s; backdrop-filter: blur(10px); } .net-pill { background: rgba(30,41,59,0.85); padding: 5px 12px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; display: none; align-items: center; backdrop-filter: blur(10px); color: #34d399; border: 1px solid #0f9d6e; } .video-header .net-pill { margin-left: auto; align-self: center; } #filePreviewModal .preview-img { max-width: 100%; max-height: 200px; margin-bottom: 12px; border-radius: 8px; } #filePreviewModal .caption-input { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface-2); color: var(--text); } #filePreviewModal .view-once-checkbox { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 0.95rem; } .msg-action { position: absolute; top: 50%; transform: translateY(-50%); left: -80px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; font-size: 0.9rem; color: var(--danger); cursor: pointer; z-index: 10; display: none; white-space: nowrap; user-select: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; } .msg.me:hover .msg-action, .msg.me.long-press .msg-action, .msg.me.clicked .msg-action { display: block; opacity: 1; transform: translateY(-50%) translateX(5px); } @media (max-width: 500px) { .msg-action { left: -70px; font-size: 0.82rem; padding: 5px 10px; } } .card:not(.hidden) { opacity: 1; transform: translateY(0); } .hidden { display: none !important; } @media (max-width: 500px) { .video-header .net-pill { padding: 4px 10px; font-size: 0.78rem; } #localVideo.pip, #remoteVideo.pip { width: 100px !important; height: 133px !important; bottom: 16px; right: 16px; } } </style>
</head>
<body>
<style>
.media-status-overlay {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(0,0,0,0.65);
  color: #fbbf24;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  z-index: 15;
  backdrop-filter: blur(4px);
  border: 2px solid rgba(251,191,36,0.5);
  transition: opacity 0.4s ease, transform 0.3s ease;
}

.media-status-overlay.hidden {
  opacity: 0;
  transform: scale(0.85);
  pointer-events: none;
}

/* Saat video di mode PIP (kecil) */
#remoteVideo.pip ~ #micStatusRemote,
#localVideo.pip ~ #micStatusLocal {
  width: 32px;
  height: 32px;
  font-size: 1.1rem;
  top: 6px;
  left: 6px;
  border-width: 1.5px;
}
</style>
<div class="screen" id="loginScreen">
  <div id="welcomeContent">
    <div class="logo-big">üí¨</div>
    <h1>Anonymous</h1>
    <div class="subtitle">Ngobrol santai dengan orang baru</div>
    <button onclick="showLoginForm()">Mulai</button>
  </div>

  <div class="card hidden" id="loginForm">
    <h2>Sanz project</h2>

    <input id="name" placeholder="Nama (opsional)" autocomplete="off"/>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0 4px; font-weight:500; color:var(--text-sec)">
      <span>Umur</span>
      <span id="ageVal">21</span>
    </div>
    <input id="age" type="range" min="13" max="80" value="21" oninput="ageVal.innerText=this.value"/>

    <select id="gender">
      <option value="" disabled selected>Gender</option>
      <option>Laki-laki</option>
      <option>Perempuan</option>
    </select>

    <select id="job">
      <option value="" disabled selected>Status saat ini</option>
      <option>Sekolah</option>
      <option>Kerja</option>
      <option>Pengangguran</option>
      <option>Lainnya</option>
    </select>

    <select id="server">
      <option value="server1">Server 1</option>
      <option value="server2">Server 2</option>
      <option value="server3">Server 3</option>
    </select>

    <button onclick="start()">Masuk Chat</button>
  </div>
</div>

<div class="screen" id="searching" style="display:none; flex-direction:column; gap:1.5rem;">
  <div class="loader"></div>
  <div style="font-size:1.1rem; opacity:0.9">Mencari temen ngobrol...</div>
</div>

<div id="chat">
  <div class="header">
    <div class="partner-info">
      <div class="partner-name" id="partnerName">Menghubungkan...</div>
      <div class="partner-status" id="partnerStatus">Online</div>
    </div>
    <div style="display:flex; gap:16px; font-size:1.4rem;">
      <i class="bi bi-arrow-clockwise" id="refreshBtn" onclick="refreshChat()" style="display:none; cursor:pointer"></i>
      <i class="bi bi-camera-video-fill" onclick="callUser()" id="videoCallBtn" style="cursor:pointer"></i>
      <i class="bi bi-person-circle" onclick="openProfile()" style="cursor:pointer"></i>
      <i class="bi bi-box-arrow-right" onclick="logout()" style="cursor:pointer; color:#f87171"></i>
    </div>
  </div>

  <div class="encryption-info">
    <i class="bi bi-lock-fill"></i>
    End-to-end encrypted
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Ketik pesan..." autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage()"/>
    <button onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
    <input type="file" id="fileInput" style="display:none;" onchange="previewFile()"/>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<div id="videoScreen" class="video-wrap">
  <div class="video-header">
    <span id="callName">Video Call</span>
    <div class="net-pill" id="netStatus">
      <span id="netLeft">‚Äî ms</span>
    </div>
  </div>

<div class="video-body">
  <!-- Icon mute untuk remote video (wajah partner) -->
  <div id="micStatusRemote" class="media-status-overlay hidden mic" title="Mikrofon partner dimatikan">
    <i class="bi bi-mic-mute-fill"></i>
  </div>

  <!-- Icon mute untuk local video (wajah kamu sendiri) -->
  <div id="micStatusLocal" class="media-status-overlay hidden mic" title="Mikrofon kamu dimatikan">
    <i class="bi bi-mic-mute-fill"></i>
  </div>

  <video id="remoteVideo" autoplay playsinline class="full"></video>
  <video id="localVideo" autoplay muted playsinline class="pip"></video>
</div>

  <div class="video-footer">
    <i id="micBtn"   class="bi bi-mic-fill"        onclick="toggleMic()"></i>
    <i id="camBtn"   class="bi bi-camera-video-fill" onclick="toggleCam()"></i>
    <i class="bi bi-arrow-repeat" onclick="switchCamera()"></i>
    <i class="bi bi-telephone-x-fill end-call" onclick="endCall()"></i>
  </div>
</div>

<div id="viewOnceModal">
  <div class="vo-header" id="voHeader">Foto dari ...</div>
  <div class="vo-content">
    <img id="voFullImage" class="vo-img" alt="View once image" />
  </div>
  <button class="vo-close-btn" onclick="closeViewOnce()">Tutup</button>
</div>

<div id="deleteConfirmModal" class="modal" style="display:none;">
  <div class="modal-box">
    <p style="font-size:1.05rem;">
      Hapus pesan ini untuk semua orang?<br>
    </p>
    <div style="display:flex; gap:12px; margin-top:1rem;">
      <button onclick="confirmDelete()" style="flex:1; background:var(--danger);">Hapus</button>
      <button onclick="closeDeleteModal()" style="flex:1;">Batal</button>
    </div>
  </div>
</div>

<div id="incomingCall" class="modal">
  <div class="modal-box">
    <h3>Panggilan Video Masuk</h3>
    <p id="callerName" style="margin:1rem 0; font-size:1.1rem"></p>
    <button onclick="acceptCall()">Terima</button>
    <button class="btn-danger" onclick="rejectCall()">Tolak</button>
  </div>
</div>

<div id="rejectedModal" class="modal">
  <div class="modal-box">
    <div style="font-size:3rem; color:var(--danger); margin-bottom:1rem;">‚úñ</div>
    <p id="rejectedText" style="margin-bottom:1.5rem"></p>
    <button onclick="closeRejected()">Tutup</button>
  </div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-box" style="text-align:left">
    <h3>Profil Partner</h3>
    <div id="profileContent" style="margin:1.2rem 0; line-height:1.7; color:var(--text-sec)"></div>
    <button onclick="closeProfile()">Tutup</button>
  </div>
</div>

<div id="waitingModal" class="modal">
  <div class="modal-box">
    <div class="loader" style="margin:0 auto 1.5rem"></div>
    <p id="waitingText">Menunggu partner menerima...</p>
  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box">
    <p id="alertText" style="margin-bottom:1.5rem; font-size:1rem"></p>
    <button onclick="closeAlert()">OK</button>
  </div>
</div>

<div id="filePreviewModal" class="modal" style="display:none;">
  <div class="modal-box" style="max-width: 400px; padding: 24px 20px;">
    <h3 style="margin-bottom: 1.2rem;">Pratinjau Gambar</h3>
    
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img id="previewImage" class="preview-img" style="display:none; max-height: 260px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);"/>
    </div>

    <input 
      id="captionInput" 
      class="caption-input" 
      placeholder="Tambahkan caption (opsional)" 
      style="margin-bottom: 1.4rem;"
    />

    <label class="view-once-checkbox" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; cursor: pointer; user-select: none;">
      <input type="checkbox" id="viewOnceCheckbox" style="width: 18px; height: 18px; accent-color: var(--accent);"/>
      <span style="margin-bottom:11px;font-size: 0.97rem; color: var(--text);">Kirim sebagai pesan sekali lihat</span>
    </label>

    <div style="display: flex; gap: 12px; margin-top: 0.8rem;">
      <button onclick="sendFile()" style="flex: 1;">Kirim</button>
      <button class="btn-danger" onclick="cancelFilePreview()" style="flex: 1;">Batal</button>
    </div>
  </div>
</div>

<div id="actionToast"></div>

<script>
const socket = io("https://chat-jsb8.onrender.com");

let partner = null;
let pc, localStream;
let isFront = true;
let isPipSwapped = false;
let callPending = false;
let lastRTT = 0;
let selectedFile = null;
let messageIdCounter = 0; 
let messagesMap = {}; 
let myMicEnabled = true;
let myCamEnabled = true;
let partnerMicEnabled = true; 

const ice = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

socket.on('message-confirmed', ({ id }) => {
  console.log('Pesan dikonfirmasi, ID:', id);

  const lastMsg = document.querySelector('.msg.me:last-child');
  if (lastMsg && lastMsg.dataset.msgId.startsWith('temp-')) {
    const oldTempId = lastMsg.dataset.msgId;
    lastMsg.dataset.msgId = id;
    messagesMap[id] = lastMsg;
    delete messagesMap[oldTempId];

    const action = lastMsg.querySelector('.msg-action');
    if (action) {
      action.style.display = 'block';  
    }
  }
});

// Tambahkan di bagian atas script (global)


// Fungsi baru untuk update icon mute
function updateMicIcons() {
  const isMyMicMuted = !myMicEnabled;

  // Icon di local video (wajah kamu) hanya muncul jika kamu yang mute
  const localOverlay = document.getElementById("micStatusLocal");
  localOverlay?.classList.toggle("hidden", !isMyMicMuted);

  // Icon di remote video (wajah partner) hanya muncul jika partner mute
  const remoteOverlay = document.getElementById("micStatusRemote");
  remoteOverlay?.classList.toggle("hidden", partnerMicEnabled);  // partnerMicEnabled = true berarti partner tidak mute
}

document.getElementById("localVideo").onclick = function() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = !isPipSwapped;

  if (isPipSwapped) {
    local.classList.remove("pip");
    local.classList.add("full");
    remote.classList.remove("full");
    remote.classList.add("pip");
  } else {
    local.classList.remove("full");
    local.classList.add("pip");
    remote.classList.remove("pip");
    remote.classList.add("full");

    local.style.transform  = isFront ? "scaleX(-1)" : "none";
    remote.style.transform = "none";
  }

  local.style.zIndex  = isPipSwapped ? "5"  : "10";
  remote.style.zIndex = isPipSwapped ? "10" : "5";

  // Update posisi icon setelah swap
  updateMicIcons();
};
// Panggil fungsi ini setiap kali status berubah atau PIP swap
let pendingDeleteMsgId = null;
let pendingDeleteBubble = null;
let pendingDeleteAction = null;

function openDeleteConfirm(msgId, bubbleElement, actionElement) {
  pendingDeleteMsgId = msgId;
  pendingDeleteBubble = bubbleElement;
  pendingDeleteAction = actionElement;

  if (actionElement) actionElement.style.display = 'block';

  document.getElementById("deleteConfirmModal").style.display = "grid";
}

function closeDeleteModal() {
  if (pendingDeleteAction) {
    pendingDeleteAction.style.display = 'none';
  }

  pendingDeleteMsgId = null;
  pendingDeleteBubble = null;
  pendingDeleteAction = null;
  document.getElementById("deleteConfirmModal").style.display = "none";
}

function confirmDelete() {
  if (!pendingDeleteMsgId) {
    closeDeleteModal();
    return;
  }

  if (pendingDeleteBubble) {
    pendingDeleteBubble.innerHTML = 'Pesan ini telah dihapus';
    pendingDeleteBubble.className = 'bubble deleted-msg';
  }

  if (pendingDeleteAction) {
    pendingDeleteAction.remove();
  }

  socket.emit('delete-for-everyone', { msgId: pendingDeleteMsgId });

  showToast("Pesan dihapus");

  closeDeleteModal();
}

function showToast(msg) {
  const t = document.getElementById("actionToast");
  t.textContent = msg;
  t.style.opacity = "1";
  t.style.transform = "translateX(-50%) translateY(0)";
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateX(-50%) translateY(20px)";
  }, 2800);
}

function showAlert(text) {
  document.getElementById("alertText").textContent = text;
  document.getElementById("alertModal").style.display = "grid";
}

function closeAlert() {
  document.getElementById("alertModal").style.display = "none";
}

function showLoginForm() {
  document.getElementById("welcomeContent").style.display = "none";
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("name").focus();
}

function start() {
  const name   = document.getElementById("name").value.trim()   || "Anonim";
  const age    = document.getElementById("age").value;
  const gender = document.getElementById("gender").value;
  const job    = document.getElementById("job").value;
  const server = document.getElementById("server").value;

  if (!gender || !job) {
    showAlert("Isi data singkat untuk mulai");
    return;
  }

  window.userData = { name, age, gender, job, server };
  socket.emit("join", { name, age, gender, job, server });

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("searching").style.display = "flex";
}

document.addEventListener('click', function(e) {
  const wrapper = e.target.closest('.view-once-wrapper, .normal-image-wrapper');
  if (!wrapper) return;

  const src = wrapper.dataset.src;
  const fromName = wrapper.dataset.from;
  const isViewOnce = wrapper.dataset.isViewonce === 'true';

  if (!src) return;

  const headerText = isViewOnce 
    ? `Gambar dari ${fromName}`
    : `Gambar dari ${fromName}`;
  
  document.getElementById('voHeader').textContent = headerText;
  document.getElementById('voFullImage').src = src;
  document.getElementById('viewOnceModal').style.display = 'flex';

  if (isViewOnce) {
    const blurLayer = wrapper.querySelector('.view-once-blur');
    if (blurLayer) {
      blurLayer.classList.add('hidden');
    }
    wrapper.style.pointerEvents = 'none'; 
    wrapper.style.opacity = '0.85';
  }
});

function addMsg(data, side, time = timeNow()) {
  const div = document.createElement("div");
  div.className = `msg ${side}`;

  let msgId = data.id;
  if (msgId) {

    div.dataset.msgId = msgId;
    messagesMap[msgId] = div;
  } else {

    const tempId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    div.dataset.msgId = tempId;
    messagesMap[tempId] = div;
  }

  let content = '';

  if (data.type === 'text' || !data.type) {
    content = `<div class="bubble">${(data.text || '').replace(/\n/g, '<br>')}</div>`;
  } 
  else if (data.type === 'file') {
    let previewHTML = '';

    const isViewOnce = data.viewOnce === true;
    const wrapperClass = isViewOnce ? 'view-once-wrapper' : 'normal-image-wrapper';
    const imgStyle = isViewOnce 
      ? 'filter: blur(18px); opacity: 0.45; transform: scale(1.05);'
      : 'filter: none; opacity: 1; transform: none;';

    previewHTML = `
      <div class="${wrapperClass}" 
           data-src="${data.fileUrl || ''}" 
           data-from="${data.fromName || (side === 'me' ? (window.userData?.name || 'Kamu') : (partner?.name || 'Partner'))}"
           data-is-viewonce="${isViewOnce ? 'true' : 'false'}">
        <img src="${data.fileUrl || ''}" 
             class="file-preview" 
             style="${imgStyle}" 
             alt="${isViewOnce ? 'View once image' : 'Shared image'}"/>
        ${isViewOnce ? `
          <div class="view-once-blur">
            <div class="view-once-icon">‚è≥</div>
            <div class="view-once-text">Foto 1x<br>Klik untuk melihat</div>
          </div>
        ` : ''}
      </div>`;

    content = `
      <div class="bubble">
        ${previewHTML}
        ${data.caption ? `<p style="margin-top:8px; font-size:0.9rem; opacity:0.9;">${data.caption}</p>` : ''}
      </div>`;

    if (isViewOnce) {
      div.classList.add('view-once');
    }
  } 
  else if (data.type === 'deleted') {
    content = `<div class="bubble deleted-msg">Pesan ini telah dihapus</div>`;
  }

  div.innerHTML = `
    ${content}
    <div class="time">${time}</div>
  `;

  if (side === 'me' && data.type !== 'deleted') {
    const action = document.createElement('div');
    action.className = 'msg-action';
    action.textContent = 'Hapus';
    action.style.display = 'none';

    action.onclick = (e) => {
      e.stopPropagation(); 
      const currentMsgId = div.dataset.msgId;

      if (currentMsgId.startsWith('temp-')) {
        showToast("Pesan belum terkirim ke server");
        return;
      }

      const bubble = div.querySelector('.bubble');
      openDeleteConfirm(currentMsgId, bubble, action);
    };

    div.appendChild(action);

    setupInteractionForDelete(div, action);
  }

  const messagesContainer = document.getElementById("messages");
  messagesContainer.appendChild(div);
  div.scrollIntoView({ behavior: "smooth", block: "end" });

  return div;
}

function timeNow() {
  const d = new Date();
  return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
}

function sendMessage() {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text || !partner) return;

  addMsg({ type: 'text', text }, "me");

  socket.emit("message", { type: 'text', text });

  input.value = "";
  input.focus();
}

function previewFile() {
  selectedFile = document.getElementById('fileInput').files[0];
  if (!selectedFile) return;

  const previewImg = document.getElementById('previewImage');
  const isImage = selectedFile.type.startsWith('image/');

  if (isImage) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';
      document.getElementById('filePreviewModal').style.display = 'grid';
    };
    reader.readAsDataURL(selectedFile);
  } else {

    previewImg.src = ''; 
    previewImg.style.display = 'none';

    showAlert("Preview hanya mendukung gambar");
    document.getElementById('filePreviewModal').style.display = 'grid';
  }
}

async function sendFile() {
  if (!selectedFile || !partner) {
    showAlert("Tidak ada file yang dipilih");
    return;
  }

  const caption = document.getElementById('captionInput').value.trim();
  const viewOnce = document.getElementById('viewOnceCheckbox').checked;

  const CLOUD_NAME    = "davgb7tjm";      
  const UPLOAD_PRESET = "sanz-chat";  

  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("upload_preset", UPLOAD_PRESET);

  try {

    showToast("Sedang mengirim...");

    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: "POST",
      body: formData
    });

    if (!response.ok) {
      const errData = await response.json();
      throw new Error(errData.error?.message || `Upload gagal (HTTP ${response.status})`);
    }

    const data = await response.json();

    if (!data.secure_url && !data.url) {
      throw new Error("Tidak mendapatkan URL gambar dari Cloudinary");
    }

    const imageUrl = data.secure_url || data.url;

    addMsg({
      type: 'file',
      fileUrl: imageUrl,
      caption: caption || undefined,
      viewOnce: viewOnce,
      fromName: window.userData?.name || "Anonim" 
    }, "me");

    socket.emit("message", {
      type: 'file',
      fileUrl: imageUrl,
      caption: caption || null,
      viewOnce: viewOnce,
      fromName: window.userData?.name || "Anonim"
    });

    showToast(viewOnce ? "Gambar terkirim!" : "Gambar terkirim!");

  } catch (err) {
    console.error("Gagal upload ke Cloudinary:", err);
    showAlert("Gagal mengirim gambar:\n" + (err.message || "Cek koneksi"));
  }

  cancelFilePreview();

  document.getElementById('fileInput').value = '';
}

function cancelFilePreview() {
  selectedFile = null;
  document.getElementById('previewImage').style.display = 'none';
  document.getElementById('captionInput').value = '';
  document.getElementById('viewOnceCheckbox').checked = false;
  document.getElementById('filePreviewModal').style.display = 'none';
}

function setupInteractionForDelete(msgElement, actionElement) {
  let pressTimer;

  msgElement.addEventListener('touchstart', () => {
    pressTimer = setTimeout(() => {
      msgElement.classList.add('long-press');
      actionElement.style.display = 'block';
    }, 500); 
  });

  msgElement.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
    setTimeout(() => {
      msgElement.classList.remove('long-press');
      actionElement.style.display = 'none'; 
    }, 3000); 
  });

  msgElement.addEventListener('touchmove', () => {
    clearTimeout(pressTimer);
    msgElement.classList.remove('long-press');
    actionElement.style.display = 'none';
  });

  msgElement.addEventListener('click', (e) => {

    if (e.target === actionElement || actionElement.contains(e.target)) return;

    if (msgElement.classList.contains('clicked')) {
      msgElement.classList.remove('clicked');
      actionElement.style.display = 'none';
    } else {
      msgElement.classList.add('clicked');
      actionElement.style.display = 'block';
    }
  });
}

function deleteForEveryone(msgId) {
  if (!msgId || msgId.startsWith('temp-')) {
    showToast("Pesan belum terkirim ke server");
    return;
  }

  socket.emit('delete-for-everyone', { msgId });
  updateMsgAsDeleted(msgId); 
}

function updateMsgAsDeleted(msgId) {
  const msgDiv = messagesMap[msgId];
  if (msgDiv) {

    const bubble = msgDiv.querySelector('.bubble');
    if (bubble) {
      bubble.innerHTML = 'Pesan ini telah dihapus';
      bubble.className = 'bubble deleted-msg';
    }

    const action = msgDiv.querySelector('.msg-action');
    if (action) action.remove();

    const timeEl = msgDiv.querySelector('.time');
    if (timeEl) timeEl.textContent = timeNow();
  } else {
    console.warn(`Pesan dengan ID ${msgId} tidak ditemukan saat dihapus`);
  }
}

socket.on("matched", p => {
  partner = p;
  document.getElementById("searching").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
  document.getElementById("partnerName").textContent = p.name;
  document.getElementById("partnerStatus").textContent = "Online";
  document.getElementById("partnerStatus").className = "partner-status status-online";
  document.getElementById("msg").disabled = false;
  document.querySelector(".footer button").disabled = false;
  document.getElementById("refreshBtn").style.display = "none";
  document.getElementById("videoCallBtn").style.display = "block";
});

socket.on("message", data => {
  const side = data.fromMe ? "me" : "other";  
  addMsg(data, side);
});

socket.on("delete-for-everyone", ({ msgId }) => updateMsgAsDeleted(msgId));

socket.on("typing", () => {
  const el = document.getElementById("partnerStatus");
  el.textContent = "Sedang mengetik‚Ä¶";
  el.className = "partner-status status-typing";
  clearTimeout(window.typingTm);
  window.typingTm = setTimeout(() => {
    el.textContent = "Online";
    el.className = "partner-status status-online";
  }, 2200);
});

document.getElementById("msg").oninput = () => socket.emit("typing");

socket.on("partner-left", () => {
  document.getElementById("partnerStatus").textContent = "Offline";
  document.getElementById("partnerStatus").className = "partner-status status-offline";
  document.getElementById("msg").disabled = true;
  document.querySelector(".footer button").disabled = true;
  document.getElementById("refreshBtn").style.display = "block";
});

async function startMedia() {
  try {
    // Minta akses media baru (kamera + mikrofon)
    localStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "user",
        width: { ideal: 640 },
        height: { ideal: 480 },
        aspectRatio: { ideal: 4/3 }
      },
      audio: true
    });

    // Ambil track video dan audio dari stream baru
    const videoTrack = localStream.getVideoTracks()[0];
    const audioTrack = localStream.getAudioTracks()[0];

    // Terapkan status mute terakhir ke track-track tersebut
    if (videoTrack) {
      videoTrack.enabled = myCamEnabled;  // gunakan status cam terakhir
    }

    if (audioTrack) {
      audioTrack.enabled = myMicEnabled;  // gunakan status mic terakhir
    }

    // Update tampilan tombol footer sesuai status yang sudah diterapkan
    document.getElementById("camBtn").className = 
      (videoTrack && videoTrack.enabled) 
        ? "bi bi-camera-video-fill" 
        : "bi bi-camera-video-off-fill muted";

    document.getElementById("micBtn").className = 
      myMicEnabled 
        ? "bi bi-mic-fill" 
        : "bi bi-mic-mute-fill muted";

    // Pasang stream ke video lokal
    const localVideo = document.getElementById("localVideo");
    localVideo.srcObject = localStream;
    localVideo.play().catch(e => console.log("Play error:", e));

    // Optional: kirim status terkini ke partner (agar icon mute di sisi partner sinkron)
    socket.emit("media-status", { 
      mic: myMicEnabled,
      cam: myCamEnabled 
    });

    return true;
  } catch (err) {
    console.error("getUserMedia gagal:", err);
    showAlert("Tidak bisa akses kamera/mikrofon: " + err.message);
    return false;
  }
}

function createPeer() {
  if (pc) pc.close();
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      { urls: "stun:stun2.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = e => {
    if (e.candidate) {
      console.log("Kirim ICE candidate");
      socket.emit("ice", e.candidate);
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE state:", pc.iceConnectionState);
    checkSignal();  
  };

  pc.onconnectionstatechange = () => {
    console.log("Connection state:", pc.connectionState);
    checkSignal();  

    if (pc.connectionState === "connected") {
      console.log("WebRTC CONNECTED!");

    } else if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
      console.log("WebRTC gagal/terputus");
      showToast("Koneksi video terputus");
    }
  };

  pc.ontrack = e => {
    console.log("Menerima track remote!");
    const rv = document.getElementById("remoteVideo");
    rv.srcObject = e.streams[0];
    rv.play().catch(err => console.log("Auto-play error:", err));
  };

  return pc;
}

function updateConnectionUI() {
  if (!pc) return;
  const st = pc.connectionState;
  if (st === "connected") {
    document.getElementById("netStatus").style.display = "flex";
  } else if (st === "disconnected" || st === "failed") {
    document.getElementById("netStatus").style.display = "none";
  }
}

async function updateLatency() {
  if (!pc) {
    console.log("[LATENCY] pc tidak ada ‚Üí skip update");
    document.getElementById("netLeft").textContent = "‚Äî ms";
    return;
  }

  if (pc.connectionState !== "connected") {
    console.log("[LATENCY] Skip update: state bukan connected (" + pc.connectionState + ")");
    document.getElementById("netLeft").textContent = "‚Äî ms";
    return;
  }

  console.log("[LATENCY] Mulai ambil stats RTC...");

  try {
    const stats = await pc.getStats();
    let rtt = -1;
    let foundAny = false;

    stats.forEach(report => {
      if (report.type === 'candidate-pair') {
        if (report.currentRoundTripTime !== undefined && report.currentRoundTripTime > 0) {
          if (report.nominated || report.selectedCandidatePairId || report.state === 'succeeded') {
            rtt = Math.round(report.currentRoundTripTime * 1000);
            foundAny = true;
            console.log("[LATENCY] Dapat RTT dari candidate-pair (nominated/succeeded):", rtt, "ms");
          }
        }
      }
    });

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'candidate-pair' && report.currentRoundTripTime > 0) {
          rtt = Math.round(report.currentRoundTripTime * 1000);
          foundAny = true;
          console.log("[LATENCY] Dapat RTT dari candidate-pair (fallback):", rtt, "ms");
        }
      });
    }

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'remote-inbound-rtp' && report.roundTripTime > 0) {
          rtt = Math.round(report.roundTripTime * 1000);
          foundAny = true;
          console.log("[LATENCY] Dapat RTT dari remote-inbound-rtp:", rtt, "ms");
        }
      });
    }

    const netLeft = document.getElementById("netLeft");
    const netPill = document.getElementById("netStatus");

    if (rtt > 0 && !isNaN(rtt)) {
      lastRTT = rtt;
      netLeft.textContent = `${lastRTT} ms`;
      console.log("[LATENCY] Sukses update UI ‚Üí", lastRTT, "ms");

      netPill.style.color = '#34d399';
      netPill.style.borderColor = '#0f9d6e';

      if (lastRTT > 150) {
        netPill.style.color = '#f59e0b';
        netPill.style.borderColor = '#d97706';
      }
      if (lastRTT > 300) {
        netPill.style.color = '#ef4444';
        netPill.style.borderColor = '#b91c1c';
      }
    } else {
      netLeft.textContent = foundAny ? "‚Äî ms" : "No RTT";
      netPill.style.color = '#94a3b8';
      netPill.style.borderColor = '#475569';
      console.log("[LATENCY] RTT tidak ditemukan atau 0 ‚Üí tampil", netLeft.textContent);
    }
  } catch (err) {
    console.error("[LATENCY] Error saat getStats:", err.name, err.message);
    document.getElementById("netLeft").textContent = "Err";
    document.getElementById("netStatus").style.color = '#ef4444';
    document.getElementById("netStatus").style.borderColor = '#b91c1c';
  }
}

function checkSignal() {
  if (!pc) {
    console.log("[NET] pc tidak ada ‚Üí hide pill");
    document.getElementById("netStatus").style.display = "none";
    return;
  }

  const state = pc.connectionState;
  console.log("[NET] Connection state saat ini:", state);

  const netPill = document.getElementById("netStatus");

  if (state === "connected") {
    console.log("[NET] CONNECTED ‚Üí tampilkan pill & mulai latency");
    netPill.style.display = "flex";
    updateLatency();  
    clearInterval(window.latencyInterval);
    window.latencyInterval = setInterval(() => {
      console.log("[NET] Update latency interval...");
      updateLatency();
    }, 1000);  
  } else if (state === "connecting" || state === "new") {
    console.log("[NET] Connecting ‚Üí tampilkan 'Connecting...'");
    netPill.style.display = "flex";
    document.getElementById("netLeft").textContent = "Connecting...";
  } else {
    console.log("[NET] State lain (" + state + ") ‚Üí sembunyikan pill");
    netPill.style.display = "none";
    clearInterval(window.latencyInterval);
    document.getElementById("netLeft").textContent = "‚Äî ms";
    lastRTT = 0;
  }
}

async function callUser() {
  if (!partner) {
    showAlert("Belum ada partner yang terhubung!");
    return;
  }

  const waitingModal = document.getElementById("waitingModal");
  const waitingText = document.getElementById("waitingText");
  waitingText.textContent = "Menunggu " + (partner.name || "partner") + " menerima panggilan...";
  waitingModal.style.display = "grid";

  window.callTm = setTimeout(() => {
    if (waitingModal.style.display === "grid") {
      waitingModal.style.display = "none";
      showAlert("Panggilan tidak dijawab.");
    }
  }, 30000);

  try {
    const hasMedia = await startMedia();
    if (!hasMedia) {
      waitingModal.style.display = "none";
      return;
    }

    createPeer();

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
      console.log("Track ditambahkan:", track.kind);
    });

    socket.emit("call-user");  

  } catch (err) {
    console.error("Gagal memulai panggilan:", err);
    waitingModal.style.display = "none";
    showAlert("Gagal memulai video call: " + err.message);
  }
}

socket.on("incoming-call", d => {
  document.getElementById("callerName").textContent = d.name;
  document.getElementById("incomingCall").style.display = "grid";
});

socket.on("call-accepted", async () => {
  console.log("[CALLER] Panggilan diterima oleh partner");

  clearTimeout(window.callTm);

  const waitingModal = document.getElementById("waitingModal");
  if (waitingModal) {
    waitingModal.style.display = "none";
  }

  callPending = false;

  try {

    if (!localStream) {
      const hasMedia = await startMedia();
      if (!hasMedia) {
        showAlert("Gagal mengakses kamera/mikrofon setelah panggilan diterima");
        return;
      }
    }

    createPeer();

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
      console.log("[CALLER] Track ditambahkan ke pc setelah accepted:", track.kind);
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("[CALLER] Offer dikirim setelah accepted");

    document.getElementById("videoScreen").style.display = "flex";
    document.getElementById("callName").textContent = partner?.name || "Partner";

    resetVideoLayout();
    checkSignal();

    showToast("Menghubungkan...");

  } catch (err) {
    console.error("[CALLER] Error setelah call-accepted:", err);
    showAlert("Gagal menghubungkan video call: " + err.message);

    if (waitingModal) waitingModal.style.display = "none";
    document.getElementById("videoScreen").style.display = "none";
    endCall(); 
  }
});

function resetVideoLayout() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = false;

  local.classList.remove("full");
  local.classList.add("pip");
  remote.classList.remove("pip");
  remote.classList.add("full");

  

  local.style.zIndex = "10";
  remote.style.zIndex = "5";
}

socket.on("offer", async o => {
  if (!pc) createPeer();
  await pc.setRemoteDescription(o);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("answer", ans);
});

socket.on("answer", a => pc.setRemoteDescription(a));

socket.on("ice", c => pc?.addIceCandidate(new RTCIceCandidate(c)));

async function acceptCall() {
  document.getElementById("incomingCall").style.display = "none";

  const hasMedia = await startMedia();
  if (!hasMedia) return;

  createPeer();  

  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
    console.log("Track lokal ditambahkan ke pc:", track.kind); 
  });

  try {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("Offer dikirim dari penerima panggilan");
  } catch (err) {
    console.error("Gagal membuat offer di acceptCall:", err);
    showAlert("Gagal memulai video call: " + err.message);
    return;
  }

  socket.emit("accept-call");

  document.getElementById("videoScreen").style.display = "flex";
  document.getElementById("callName").textContent = partner?.name || "Partner";

  resetVideoLayout();
}

function rejectCall() {
  document.getElementById("incomingCall").style.display = "none";
  socket.emit("reject-call");
}

socket.on("call-rejected", () => {
  clearTimeout(window.callTm);
  document.getElementById("waitingModal").style.display = "none";
  document.getElementById("rejectedText").textContent = `${partner?.name || "Partner"} menolak panggilan.`;
  document.getElementById("rejectedModal").style.display = "grid";
});

socket.on("media-status", (status) => {
  if (status.mic !== undefined) {
    partnerMicEnabled = status.mic;  // true = partner tidak mute, false = partner mute
    updateMicIcons();
  }
});

function endCall() {
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  document.getElementById("videoScreen").style.display = "none";
  document.getElementById("netStatus").style.display = "none";
  socket.emit("end-call");
  pc = localStream = null;
  isPipSwapped = false;

  // HAPUS baris ini agar status mute tidak reset
  // myMicEnabled = true;
  // partnerMicEnabled = true;

  // Tetap sembunyikan overlay saat video call mati
  document.getElementById("remoteMicStatus")?.classList.add("hidden");

  // Opsional: update tombol footer sesuai status terakhir (tidak reset)
  document.getElementById("micBtn").className = 
    myMicEnabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill muted";

  document.getElementById("camBtn").className = 
    localStream?.getVideoTracks()[0]?.enabled 
      ? "bi bi-camera-video-fill" 
      : "bi bi-camera-video-off-fill muted";
}

socket.on("end-call", endCall);

document.getElementById("localVideo").onclick = function() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = !isPipSwapped;

  if (isPipSwapped) {
    local.classList.remove("pip");
    local.classList.add("full");
    remote.classList.remove("full");
    remote.classList.add("pip");

  } else {
    local.classList.remove("full");
    local.classList.add("pip");
    remote.classList.remove("pip");
    remote.classList.add("full");

    local.style.transform  = isFront ? "scaleX(-1)" : "none";
    remote.style.transform = "none";

  }

  local.style.zIndex  = isPipSwapped ? "5"  : "10";
  remote.style.zIndex = isPipSwapped ? "10" : "5";
};

async function switchCamera() {
  if (!localStream) {
    showAlert("Kamera belum aktif");
    return;
  }

  try {

    const oldVideoTrack = localStream.getVideoTracks()[0];
    if (oldVideoTrack) {
      oldVideoTrack.stop();           
      localStream.removeTrack(oldVideoTrack); 
    }

    const mode = isFront ? "environment" : "user";
    isFront = !isFront; 

    const newConstraints = {
      video: {
        facingMode: { exact: mode },          
        width: { ideal: 640 },              
        height: { ideal: 480 },             
        aspectRatio: { ideal: 4/3 },           
        frameRate: { ideal: 30 }
      }
    };

    const newStream = await navigator.mediaDevices.getUserMedia(newConstraints);

    const newVideoTrack = newStream.getVideoTracks()[0];
    if (!newVideoTrack) {
      throw new Error("Tidak ada track video baru");
    }

    localStream.addTrack(newVideoTrack);

    const localVideo = document.getElementById("localVideo");
    
    localVideo.srcObject = null;
    await new Promise(resolve => setTimeout(resolve, 50)); 
    localVideo.srcObject = localStream;
    localVideo.play().catch(e => console.log("Play error:", e));

    if (pc) {
      const videoSender = pc.getSenders().find(s => s.track && s.track.kind === "video");
      if (videoSender) {
        await videoSender.replaceTrack(newVideoTrack);
        console.log("Track video berhasil diganti di peer connection");
      } else {
        console.warn("Tidak menemukan video sender");
      }
    }

    showToast(`Kamera ${isFront ? "depan" : "belakang"} aktif`);

  } catch (err) {
    console.error("Switch camera gagal:", err.name, err.message);
    showAlert("Gagal ganti kamera: " + (err.message || "Coba restart halaman"));

    isFront = !isFront;
  }
}

function closeViewOnce() {
  const modal = document.getElementById('viewOnceModal');
  const img = document.getElementById('voFullImage');
  
  modal.style.display = 'none';
  
  img.src = '';
  
  document.getElementById('voHeader').textContent = 'Foto dari ...';
}

function toggleMic() {
  if (!localStream) return;
  const tr = localStream.getAudioTracks()[0];
  if (!tr) return;

  myMicEnabled = !myMicEnabled;
  tr.enabled = myMicEnabled;

  document.getElementById("micBtn").className = 
    myMicEnabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill muted";

  socket.emit("media-status", { mic: myMicEnabled });

  // Update icon di layar sendiri & partner
  updateMicIcons();
}

function toggleCam() {
  if (!localStream) return;
  const tr = localStream.getVideoTracks()[0];
  if (!tr) return;

  myCamEnabled = !myCamEnabled;
  tr.enabled = myCamEnabled;

  document.getElementById("camBtn").className = 
    myCamEnabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill muted";
}

function openProfile() {
  if (!partner) return;
  document.getElementById("profileContent").innerHTML = `
    <div><b>Nama:</b> ${partner.name}</div>
    <div><b>Umur:</b> ${partner.age}</div>
    <div><b>Gender:</b> ${partner.gender || "?"}</div>
    <div><b>Status:</b> ${partner.job || "-"}</div>
    <div><b>Server:</b> ${partner.server}</div>
  `;
  document.getElementById("profileModal").style.display = "grid";
}

function closeProfile() { document.getElementById("profileModal").style.display = "none"; }
function closeRejected() { document.getElementById("rejectedModal").style.display = "none"; }

function refreshChat() {
  document.getElementById("chat").style.display = "none";
  document.getElementById("searching").style.display = "flex";
  if (window.userData) socket.emit("join", window.userData);
}

function logout() {
  socket.disconnect();
  location.reload();
}
</script>
</body>
</html>
