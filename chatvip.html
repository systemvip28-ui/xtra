<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sanz</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style> :root { --bg: #0d1117; --surface: #161b22; --surface-2: #1f2937; --accent: #10b981; --accent-dark:#059669; --danger: #ef4444; --warning: #f59e0b; --success: #10b981; --text: #e2e8f0; --text-sec: #94a3b8; --border: #30363d; --me: #065f46; --other: #1e293b; } * { margin: 0; padding: 0; box-sizing: border-box; } html, body { height: 100%; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; } .view-once-wrapper img, .normal-image-wrapper img { pointer-events: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -webkit-touch-callout: none; touch-action: manipulation; } .view-once-wrapper, .normal-image-wrapper { -webkit-user-drag: none; user-drag: none; -webkit-touch-callout: none; } .view-once-blur { pointer-events: none; } #viewOnceModal { -webkit-user-select: none; user-select: none; } #viewOnceModal img.vo-img { pointer-events: none; -webkit-touch-callout: none; -webkit-user-drag: none; user-drag: none; touch-action: manipulation; } #viewOnceModal * { -webkit-touch-callout: none !important; user-select: none !important; } .vo-content::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.01); pointer-events: none; z-index: 3; } .screen { height: 100dvh; display: grid; place-items: center; padding: 16px; } .card { width: 100%; max-width: 420px; background: var(--surface); border-radius: 20px; border: 1px solid var(--border); padding: 28px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); } .logo-big { font-size: 3.8rem; margin-bottom: 0.5rem; text-align: center; } h1, h2, h3 { text-align: center; } h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; } h2 { margin-bottom: 1.5rem; } .subtitle { color: var(--text-sec); text-align: center; font-size: 0.95rem; margin-bottom: 1.8rem; } input, select, button { width: 100%; padding: 14px 16px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface-2); color: white; font-size: 1rem; } input::placeholder, select option:disabled { color: #64748b; } button { background: var(--accent); color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; } button:hover { background: var(--accent-dark); transform: translateY(-1px); } button:active { transform: translateY(0); } .btn-danger { background: var(--danger); } .btn-danger:hover { background: #dc2626; } #viewOnceModal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 400; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 16px; } .vo-header { width: 100%; max-width: 420px; color: white; font-size: 1.1rem; font-weight: 600; padding: 12px 16px; background: rgba(30,41,59,0.6); border-radius: 12px 12px 0 0; text-align: center; backdrop-filter: blur(8px); } .vo-content { position: relative; max-width: 90vw; max-height: 70vh; border-radius: 0 0 12px 12px; overflow: hidden; background: #000; } .vo-img { max-width: 100%; max-height: 70vh; object-fit: contain; display: block; } .vo-close-btn { position: absolute; bottom: 20px; max-width: 90vw;background: #161b22; color: white; border: none; padding: 12px 28px; font-size: 1rem; font-weight: 500; cursor: pointer; backdrop-filter: blur(6px); box-shadow: 0 4px 15px rgba(0,0,0,0.5); } .vo-close-btn:hover { background: #161b22; } .screen { height: 100dvh; display: flex; justify-content: center; align-items: center; padding: 16px; } .searching-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.8rem; text-align: center; max-width: 320px; width: 100%; } .searching-text { font-size: 1.25rem; font-weight: 500; opacity: 0.95; color: var(--text); } .searching-subtext { font-size: 0.95rem; color: var(--text-sec); line-height: 1.4; margin-top: 0.5rem; } #searching { opacity: 0; transition: opacity 0.4s ease; } #searching[style*="display: flex"], #searching[style*="display:block"] { opacity: 1; } .loader { width: 48px; height: 48px; border: 5px solid #2d3748; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } } #chat { display: none; flex-direction: column; height: 100dvh; } .header { height: 64px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-weight: 500; } .partner-info { line-height: 1.3; } .partner-name { font-size: 1.1rem; font-weight: 600; } .partner-status { font-size: 0.82rem; opacity: 0.8; } .status-online { color: #34d399; } .status-offline { color: #f87171; } .status-typing { color: #fbbf24; font-style: italic; } .encryption-info { display: flex; align-items: center; justify-content: center; background: var(--surface-2); padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; color: var(--text-sec); gap: 6px; } .encryption-info i { font-size: 0.8rem; color: var(--success); } #messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; } .msg { max-width: 78%; display: flex; flex-direction: column; position: relative; user-select: none; } .me { align-self: flex-end; } .other { align-self: flex-start; } .bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.96rem; line-height: 1.4; word-break: break-word; } .me .bubble { background: var(--me); border-bottom-right-radius: 4px; } .other .bubble { background: var(--other); border-bottom-left-radius: 4px; } .time { font-size: 0.68rem; opacity: 0.6; margin-top: 3px; align-self: flex-end; } .file-preview { max-width: 100%; max-height: 200px; border-radius: 8px; } .view-once { opacity: 0.7; font-style: italic; } .deleted-msg { font-style: italic; color: var(--text-sec); } .footer { padding: 12px 16px; background: var(--surface); border-top: 1px solid var(--border); display: flex; gap: 10px; } .footer input { flex: 1; border-radius: 999px; padding: 12px 20px; border: none; } .footer button { background:#10b981;width: 48px; height: 48px; border-radius: 50%; font-size: 1.4rem; display: grid; place-items: center; padding: 0; } .video-wrap { position: fixed; inset: 0; background: black; display: none; flex-direction: column; z-index: 100; } .video-header { height: 56px; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 1.05rem; backdrop-filter: blur(10px); } .video-body { flex: 1; position: relative; background: #000; } video { transform: scaleX(-1) !important; } video { width: 100%; height: 100%; object-fit: cover; transition: all 0.4s ease; } video#localVideo, video#remoteVideo, #localVideo.pip, #localVideo.full, #remoteVideo.pip, #remoteVideo.full { transform: scaleX(-1) !important; } #localVideo.pip, #remoteVideo.pip { position: absolute; bottom: 20px; right: 20px; width: 120px !important; height: 160px !important; border-radius: 16px; border: 3px solid rgba(255,255,255,0.25); box-shadow: 0 8px 25px rgba(0,0,0,0.6); background: black; object-fit: cover; cursor: pointer; z-index: 10; } #localVideo.full, #remoteVideo.full { position: static; width: 100% !important; height: 100% !important; border-radius: 0 !important; border: none !important; box-shadow: none !important; z-index: 5; } #localVideo { transform: scaleX(-1); } video.pip-normal { width: 120px !important; height: 160px !important; bottom: 20px !important; right: 20px !important; border-radius: 16px; border: 3px solid rgba(255,255,255,0.25); box-shadow: 0 8px 25px rgba(0,0,0,0.6); } video.pip-mini { width: 96px !important; height: 128px !important; bottom: 100px !important; right: 16px !important; border: 2px solid #10b981; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); } #localVideo.pip, #remoteVideo.pip { position: absolute; background: black; object-fit: cover; cursor: pointer; z-index: 10; } #videoCallBtn.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; } #videoCallBtn { transition: opacity 0.2s; } .media-status-overlay { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.65); color: #fbbf24; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; z-index: 15; backdrop-filter: blur(4px); border: 2px solid rgba(251,191,36,0.5); transition: opacity 0.4s ease, transform 0.3s ease; } .media-status-overlay.hidden { opacity: 0; transform: scale(0.85); pointer-events: none; } #remoteVideo.pip ~ #micStatusRemote, #localVideo.pip ~ #micStatusLocal { width: 32px; height: 32px; font-size: 1.1rem; top: 6px; left: 6px; border-width: 1.5px; } .video-footer { height: 80px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; gap: 24px; } .video-footer i { font-size: 1.6rem; width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.08); display: grid; place-items: center; cursor: pointer; transition: all 0.2s; } .video-footer i:hover { background: rgba(255,255,255,0.15); } .video-footer i.muted { color: #fca5a5; background: rgba(239,68,68,0.18); } .video-footer .end-call { background: var(--danger); } .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; place-items: center; z-index: 200; backdrop-filter: blur(4px); } .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 28px; width: 90%; max-width: 360px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); } .modal-box button { margin: 8px 0; } #actionToast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(30,41,59,0.92); color: white; padding: 12px 24px; border-radius: 999px; font-size: 0.95rem; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.4s, transform 0.4s; backdrop-filter: blur(10px); } .net-pill { background: rgba(30,41,59,0.85); padding: 5px 12px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; display: none; align-items: center; backdrop-filter: blur(10px); color: #34d399; border: 1px solid #0f9d6e; } .video-header .net-pill { margin-left: auto; align-self: center; } #filePreviewModal .preview-img { max-width: 100%; max-height: 200px; margin-bottom: 12px; border-radius: 8px; } #filePreviewModal .caption-input { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface-2); color: var(--text); } #filePreviewModal .view-once-checkbox { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 0.95rem; } .msg-action { position: absolute; top: 50%; transform: translateY(-50%); left: -80px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; font-size: 0.9rem; color: var(--danger); cursor: pointer; z-index: 10; display: none; white-space: nowrap; user-select: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; } .msg.me:hover .msg-action, .msg.me.long-press .msg-action, .msg.me.clicked .msg-action { display: block; opacity: 1; transform: translateY(-50%) translateX(5px); } @media (max-width: 500px) { .msg-action { left: -70px; font-size: 0.82rem; padding: 5px 10px; } } .card:not(.hidden) { opacity: 1; transform: translateY(0); } .hidden { display: none !important; } @media (max-width: 500px) { .video-header .net-pill { padding: 4px 10px; font-size: 0.78rem; } #localVideo.pip, #remoteVideo.pip { width: 100px !important; height: 133px !important; bottom: 16px; right: 16px; } } </style>
</head>
<body>

<div class="screen" id="loginScreen">
  <div id="welcomeContent">
    <div class="logo-big">ðŸ’¬</div>
    <h1>Anonymous</h1>
    <div class="subtitle">Ngobrol santai dengan orang baru</div>
    <button onclick="showLoginForm()">Mulai</button>
  </div>

  <div class="card hidden" id="loginForm">
    <h1>Sanz project</h1>
  <div class="subtitle">Masuk untuk memulai percakapan anonim</div>
    <input id="name" placeholder="Nama (opsional)" autocomplete="off"/>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0 4px; font-weight:500; color:var(--text-sec)">
      <span>Umur</span>
      <span id="ageVal">21</span>
    </div>
    <input id="age" type="range" min="13" max="80" value="21" oninput="ageVal.innerText=this.value"/>

    <select id="gender">
      <option value="" disabled selected>Gender</option>
      <option>Laki-laki</option>
      <option>Perempuan</option>
    </select>

    <select id="job">
      <option value="" disabled selected>Status saat ini</option>
      <option>Sekolah</option>
      <option>Kerja</option>
      <option>Pengangguran</option>
      <option>Lainnya</option>
    </select>

    <select id="server">
      <option value="server1">Server 1</option>
      <option value="server2">Server 2</option>
      <option value="server3">Server 3</option>
    </select>

    <button onclick="start()" style="margin-top: 10px;">Masuk Chat</button>
  </div>
</div>

<div class="screen" id="searching" style="display:none; flex-direction:column; gap:2.5rem; background: linear-gradient(135deg, #0d1117, #161b22);">
  <div class="loader-container">
    <div class="pulse-ring"></div>
    <div class="pulse-ring delay-1"></div>
    <div class="pulse-ring delay-2"></div>
    
    <div class="main-loader">
      <div class="spinner"></div>
      <div class="inner-glow"></div>
    </div>
  </div>

  <div class="searching-text-wrapper">
    <h2 class="searching-text" id="searchStatus">Mencari partner</h2>
    <p class="searching-subtext" id="dynamicText">Sedang menghubungkan ke server</p>
  </div>

  <div class="online-counter">
    <div class="online-dot"></div>
    <span id="onlineCount">0</span>sedang online
  </div>
</div>

<div id="chat">
  <div class="header">
    <div class="partner-info">
      <div class="partner-name" id="partnerName">Menghubungkan...</div>
      <div class="partner-status" id="partnerStatus">Online</div>
    </div>
    <div style="display:flex; gap:16px; font-size:1.4rem;">
      <i class="bi bi-arrow-clockwise" id="refreshBtn" onclick="refreshChat()" style="display:none; cursor:pointer"></i>
      <i class="bi bi-camera-video-fill" id="videoCallBtn" style="cursor:pointer"></i>
      <i class="bi bi-person-circle" onclick="openProfile()" style="cursor:pointer"></i>
      <i class="bi bi-box-arrow-right" onclick="logout()" style="cursor:pointer; color:#f87171"></i>
    </div>
  </div>

  <div class="encryption-info">
    <i class="fa-solid fa-lock"></i>
    End-to-end encrypted
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Ketik pesan..." autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage()"/>
    <button onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
    <input type="file" id="fileInput" style="display:none;" onchange="previewFile()"/>
    <button onclick="sendMessage()">
     <i class="bi bi-send-fill"></i>
    </button>
  </div>
</div>

<div id="videoScreen" class="video-wrap">
  <div class="video-header">
    <span id="callName">Video Call</span>
    <div class="net-pill" id="netStatus">
      <span id="netLeft">â€” ms</span>
    </div>
  </div>

<div class="video-body">
  <div id="micStatusRemote" class="media-status-overlay hidden mic" title="Mikrofon partner dimatikan">
    <i class="bi bi-mic-mute-fill"></i>
  </div>

  <div id="micStatusLocal" class="media-status-overlay hidden mic" title="Mikrofon kamu dimatikan">
    <i class="bi bi-mic-mute-fill"></i>
  </div>

  <video id="remoteVideo" autoplay playsinline class="full"></video>
  <video id="localVideo" autoplay muted playsinline class="pip"></video>
</div>

<div class="video-footer">
  <i id="micBtn"   class="bi bi-mic-fill"        onclick="toggleMic()"></i>
  <i id="camBtn"   class="bi bi-camera-video-fill" onclick="toggleCam()"></i>
  <i class="bi bi-arrow-repeat" onclick="switchCamera()"></i>
  
  <i class="bi bi-box-arrow-down-right" 
     id="minimizeCallBtn"
     onclick="minimizeToPartnerView()"
     title="Kecilkan & tetap lihat partner sambil chat"
     style="font-size:1.5rem; cursor:pointer;"></i>
  
  <i class="bi bi-telephone-x-fill end-call" onclick="endCall()"></i>
  </div>
</div>
<style>
/* â”€â”€ SEARCHING SCREEN â”€â”€ */
#searching {
  background: linear-gradient(135deg, #0d1117 0%, #0f172a 100%);
  color: var(--text);
}

.loader-container {
  position: relative;
  width: 120px;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pulse-ring {
  position: absolute;
  width: 100%;
  height: 100%;
  border: 4px solid var(--accent);
  border-radius: 50%;
  opacity: 0;
  animation: pulse 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
}

.pulse-ring.delay-1 { animation-delay: 0.6s; }
.pulse-ring.delay-2 { animation-delay: 1.2s; }

@keyframes pulse {
  0%   { transform: scale(0.5); opacity: 0.4; }
  50%  { opacity: 0.8; }
  100% { transform: scale(1.8); opacity: 0; }
}

.main-loader {
  position: relative;
  width: 80px;
  height: 80px;
}

.spinner {
  width: 100%;
  height: 100%;
  border: 6px solid #2d3748;
  border-top: 6px solid var(--accent);
  border-radius: 50%;
  animation: spin 1.1s linear infinite;
  box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
}

.inner-glow {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at center, rgba(16,185,129,0.25) 0%, transparent 70%);
  border-radius: 50%;
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { opacity: 0.4; transform: scale(0.9); }
  to   { opacity: 0.8; transform: scale(1.15); }
}

.searching-text-wrapper {
  text-align: center;
}

.searching-text {
  font-size: 1.6rem;
  font-weight: 700;
  margin-top: 35px;
  margin-bottom: 0.8rem;
  color: var(--accent);
  animation: textPulse 3s infinite;
}

@keyframes textPulse {
  0%,100% { opacity: 0.9; }
  50%     { opacity: 1; }
}

.searching-subtext {
  font-size: 1.1rem;
  color: var(--text-sec);
  max-width: 280px;
  line-height: 1;
}

.online-counter {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(16,185,129,0.12);
  padding: 10px 18px;
  border-radius: 999px;
  border: 1px solid rgba(16,185,129,0.3);
  font-size: 1rem;
  font-weight: 500;
  color: #34d399;
  backdrop-filter: blur(8px);
}

.online-dot {
  width: 12px;
  height: 12px;
  background: #34d399;
  border-radius: 50%;
  box-shadow: 0 0 12px #34d399;
  animation: blink 1.8s infinite;
}

@keyframes blink {
  0%,100% { opacity: 0.5; }
  50%     { opacity: 1; }
}

.image-placeholder {
  padding: 8px 12px;
  background: rgba(255,255,255,0.08);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: #94a3b8;
}

.image-placeholder i {
  font-size: 1.2rem;
  color: #10b981;
}

/* Bubble view-once NORMAL (belum dibuka) â†’ terang penuh */
.msg.view-once .bubble {
  background: var(--other) !important;
  opacity: 1 !important;
  cursor: pointer;
  transition: opacity 0.3s ease;
}

/* Bubble view-once SETELAH DIBUKA â†’ gelap + teks "Dilihat" */
.msg.view-once.viewed .bubble {
  opacity: 0.65 !important;
  background: var(--other) !important;
  cursor: default;
  pointer-events: none;
}

/* Teks "Dilihat" muncul di bawah bubble setelah dibuka */
.msg.view-once.viewed .bubble::after {
  content: "Dilihat";
  display: block;
  font-size: 0.7rem;
  opacity: 0.8;
  text-align: right;
  margin-top: 4px;
  color: #94a3b8;
}

.view-once {
  opacity: 1 !important;  /* override opacity 0.7 lama kalau masih ada */
}

/* Hilangkan efek pointer setelah dilihat */
.msg.view-once.viewed {
  cursor: default;
}

.vo-content {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #000;
  border-radius: 0 0 12px 12px;
  overflow: hidden;
  max-width: 90vw;
  max-height: 70vh;
  width: 100%;
  height: 100%; /* pastikan mengisi ruang yang tersedia */
}

/* Container gambar (mengambil ruang maksimal) */
.vo-img-container {
  flex: 1 1 auto;           /* mengembang mengisi ruang */
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  min-height: 0;
  overflow: hidden;
}

/* Gambar itu sendiri */
.vo-img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
}

/* Timer - selalu di bawah gambar via flex */
.vo-timer-container {
  width: 100%;
  background: rgba(15, 23, 42, 0.92);
  padding: 12px 16px;
  backdrop-filter: blur(10px);
  z-index: 15;
  flex-shrink: 0;           /* jangan sampai mengecil */
  box-shadow: 0 -4px 12px rgba(0,0,0,0.4);
}

/* Header timer + icon */
.vo-timer-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: #fbbf24;
  font-size: 1.1rem;
  font-weight: 500;
  margin-bottom: 8px;
}

.vo-timer-header i {
  font-size: 1.5rem;
}


/* Progress bar */
.vo-progress-bar {
  height: 8px;
  background: rgba(255,255,255,0.18);
  border-radius: 4px;
  overflow: hidden;
}

.vo-progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #10b981, #34d399);
  transition: width 0.4s linear;
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

/* Expired overlay - menutupi SELURUH area saat habis */
.vo-expired-overlay {
  position: absolute;
  inset: 0;
  background: rgba(15,23,42,0.94);
  backdrop-filter: blur(14px);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  z-index: 20;
  gap: 16px;
  padding: 24px;
  text-align: center;
}

.vo-expired-overlay i {
  font-size: 3rem;
  color: #ef4444;
  opacity: 0.9;
}

.vo-expired-overlay .expired-title {
  font-size: 1.8rem;
  font-weight: 700;
}

.vo-expired-overlay .expired-desc {
  font-size: 1.05rem;
  opacity: 0.85;
  max-width: 85%;
}

/* Efek blur pada gambar saat expired */
.vo-img.expired {
  filter: blur(12px) brightness(0.5);
  transition: filter 1.5s ease;
}

/* ===================== PENGONTROLAN VISIBILITAS ===================== */

/* Default: sembunyikan timer & expired */
.vo-timer-container,
.vo-expired-overlay {
  display: none;
}
/* ===================== VIEW-ONCE STYLING (mirip WhatsApp) ===================== */

/* Wrapper gambar di chat */
.view-once-wrapper {
  position: relative;
  cursor: pointer;
  user-select: none;
  border-radius: 12px;
  overflow: hidden;
  background: #0f172a;
  aspect-ratio: 3/4;
  max-width: 260px;
  margin: 4px 0;
}

/* Hapus blur besar dan overlay teks besar */
.view-once-wrapper .view-once-blur {
  display: none !important; /* Hilangkan overlay jam pasir besar */
}

/* Icon kecil jam pasir + teks "sekali lihat" di pojok */
.view-once-indicator {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(0,0,0,0.65);
  color: white;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  backdrop-filter: blur(4px);
  z-index: 5;
}

.view-once-indicator i {
  font-size: 1rem;
  color: #fbbf24;
}

/* Gambar tetap jelas (tidak blur) */
.view-once-wrapper img.file-preview {
  filter: none !important;
  opacity: 1 !important;
  transform: none !important;
}

/* Modal view-once tetap sama, tapi timer di bawah */
.vo-timer-container {
  width: 100%;
  background: rgba(15, 23, 42, 0.92);
  padding: 12px 16px;
  backdrop-filter: blur(10px);
  z-index: 15;
  flex-shrink: 0;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.4);
}

.vo-expired-overlay {
  position: absolute;
  inset: 0;
  background: rgba(15,23,42,0.94);
  backdrop-filter: blur(14px);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  z-index: 20;
  gap: 16px;
  padding: 24px;
  text-align: center;
}

/* Sisanya sama seperti sebelumnya */
.vo-img.expired {
  filter: blur(12px) brightness(0.5);
  transition: filter 1.5s ease;
}
/* Paksa tampil hanya saat view-once aktif (via JS) */
#viewOnceModal[data-viewonce="true"] .vo-timer-container {
  display: block !important;
}
</style>

<div id="viewOnceModal">
  <div class="vo-header" id="voHeader">Foto dari ...</div>
  <div class="vo-content">
    <div class="vo-img-container">
      <img id="voFullImage" class="vo-img" alt="View once image" />
    </div>

    <!-- Elemen timer & expired HANYA untuk view-once -->
    <div class="vo-timer-container viewonce-only" id="voTimerContainer">
      <div class="vo-timer-header">
        <i class="bi bi-hourglass-split"></i>
        <span>Menampilkan <span id="voCountdown">15</span> detik lagi</span>
      </div>
      <div class="vo-progress-bar">
        <div class="vo-progress-fill" id="voProgressFill"></div>
      </div>
    </div>

    <div class="vo-expired-overlay viewonce-only" id="voExpiredOverlay">
      <i class="fa-solid fa-lock"></i>
      <div class="expired-title">Expired</div>
      <div class="expired-desc">Gambar hanya bisa dilihat sekali</div>
    </div>
  </div>
  <button class="vo-close-btn" onclick="closeViewOnce()">Tutup</button>
</div>

<div id="deleteConfirmModal" class="modal" style="display:none;">
  <div class="modal-box">
    <p style="font-size:1.05rem;">
      Hapus pesan ini untuk semua orang?<br>
    </p>
    <div style="display:flex; gap:12px; margin-top:1rem;">
      <button onclick="confirmDelete()" style="flex:1; background:var(--danger);">Hapus</button>
      <button onclick="closeDeleteModal()" style="flex:1;">Batal</button>
    </div>
  </div>
</div>

<div id="miniRemoteVideoContainer" style="display:none; position:fixed; bottom:90px; right:16px; z-index:250; cursor:pointer;">
  <video id="miniRemoteVideo" autoplay playsinline style="
    width: 96px;
    height: 128px;
    border-radius: 16px;
    border: 2px solid #10b981;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    background: black;
    object-fit: cover;
  "></video>
  </div>
</div>

<div id="incomingCall" class="modal">
  <div class="modal-box">
    <h3>Panggilan Video Masuk</h3>
    <p id="callerName" style="margin:1rem 0; font-size:1.1rem"></p>
    <button onclick="acceptCall()">Terima</button>
    <button class="btn-danger" onclick="rejectCall()">Tolak</button>
  </div>
</div>

<div id="rejectedModal" class="modal">
  <div class="modal-box">
    <div style="font-size:3rem; color:var(--danger); margin-bottom:1rem;">âœ–</div>
    <p id="rejectedText" style="margin-bottom:1.5rem"></p>
    <button onclick="closeRejected()">Tutup</button>
  </div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-box" style="text-align:left">
    <h3>Profil Partner</h3>
    <div id="profileContent" style="margin:1.2rem 0; line-height:1.7; color:var(--text-sec)"></div>
    <button onclick="closeProfile()">Tutup</button>
  </div>
</div>

<div id="waitingModal" class="modal">
  <div class="modal-box">
    <div class="loader" style="margin:0 auto 1.5rem"></div>
    <p id="waitingText">Menunggu partner menerima...</p>
  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box">
    <p id="alertText" style="margin-bottom:1.5rem; font-size:1rem"></p>
    <button onclick="closeAlert()">OK</button>
  </div>
</div>

<div id="filePreviewModal" class="modal" style="display:none;">
  <div class="modal-box" style="max-width: 400px; padding: 24px 20px;">
    <h3 style="margin-bottom: 1.2rem;">Pratinjau Gambar</h3>
    
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img id="previewImage" class="preview-img" style="display:none; max-height: 260px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);"/>
    </div>

    <input 
      id="captionInput" 
      class="caption-input" 
      placeholder="Tambahkan caption (opsional)" 
      style="margin-bottom: 1.4rem;"
    />

    <label class="view-once-checkbox" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.2rem; cursor: pointer; user-select: none;">
      <input type="checkbox" id="viewOnceCheckbox" style="width: 18px; height: 18px; accent-color: var(--accent);"/>
      <span style="margin-bottom:11px;font-size: 0.97rem; color: var(--text);">Kirim sebagai pesan sekali lihat</span>
    </label>

    <div style="display: flex; gap: 12px;">
      <button onclick="sendFile()" style="flex: 1;">Kirim</button>
      <button class="btn-danger" onclick="cancelFilePreview()" style="flex: 1;">Batal</button>
    </div>
  </div>
</div>

<div id="actionToast"></div>

<script>
const socket = io("https://chat-jsb8.onrender.com");

let partner = null;
let pc, localStream;
let isFront = true;
let isPipSwapped = false;
let callPending = false;
let lastRTT = 0;
let selectedFile = null;
let messageIdCounter = 0; 
let messagesMap = {}; 
let myMicEnabled = true;
let myCamEnabled = true;
let partnerMicEnabled = true; 
let isInVideoCall = false;        

const ice = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

socket.on('message-confirmed', ({ id }) => {
  console.log('Pesan dikonfirmasi, ID:', id);

  const lastMsg = document.querySelector('.msg.me:last-child');
  if (lastMsg && lastMsg.dataset.msgId.startsWith('temp-')) {
    const oldTempId = lastMsg.dataset.msgId;
    lastMsg.dataset.msgId = id;
    messagesMap[id] = lastMsg;
    delete messagesMap[oldTempId];

    const action = lastMsg.querySelector('.msg-action');
    if (action) {
      action.style.display = 'block';  
    }
  }
});


socket.on("online-count", (count) => {
  document.getElementById("onlineCount").textContent = count;
});

// Optional: request pertama kali saat masuk searching
socket.on("connect", () => {
  if (document.getElementById("searching").style.display !== "none") {
    socket.emit("get-online-count");
  }
});

function setPartnerButtonsEnabled(enabled) {
    const videoBtn = document.getElementById("videoCallBtn");
    const profileIcon = document.querySelector('.bi-person-circle'); // atau beri id kalau mau lebih aman

    if (enabled) {
        // Kembali normal + bisa diklik
        videoBtn.style.pointerEvents   = "auto";
        videoBtn.style.cursor          = "pointer";
        videoBtn.title                 = "Mulai video call";

        profileIcon.style.pointerEvents = "auto";
        profileIcon.style.cursor        = "pointer";
    } else {
        // Nonaktifkan klik, tapi tampilan tetap normal
        videoBtn.style.pointerEvents   = "none";
        videoBtn.style.cursor          = "default";
        videoBtn.title                 = "Tidak ada partner";

        profileIcon.style.pointerEvents = "none";
        profileIcon.style.cursor        = "default";
    }
}

function updateMicIcons() {
  const isMyMicMuted = !myMicEnabled;

  const localOverlay = document.getElementById("micStatusLocal");
  localOverlay?.classList.toggle("hidden", !isMyMicMuted);

  const remoteOverlay = document.getElementById("micStatusRemote");
  remoteOverlay?.classList.toggle("hidden", partnerMicEnabled); 
}

let isMinimizedToPartner = false;

function minimizeToPartnerView() {
  if (!localStream || !document.getElementById("remoteVideo").srcObject) {
    showToast("Video belum terhubung");
    return;
  }

  isMinimizedToPartner = true;

  document.getElementById("videoScreen").style.display = "none";

  const miniContainer = document.getElementById("miniRemoteVideoContainer");
  const miniVideo = document.getElementById("miniRemoteVideo");

  miniVideo.srcObject = document.getElementById("remoteVideo").srcObject;
  miniVideo.className = "pip-mini";   
  miniVideo.play().catch(e => console.log("Mini remote play error:", e));

  miniContainer.style.display = "block";

  showToast("Mode chat aktif");
}

document.getElementById("miniRemoteVideoContainer")?.addEventListener("click", function() {
  if (!isMinimizedToPartner) return;

  isMinimizedToPartner = false;
  document.getElementById("miniRemoteVideoContainer").style.display = "none";
  document.getElementById("videoScreen").style.display = "flex";

  const remoteVideo = document.getElementById("remoteVideo");
  remoteVideo.srcObject = document.getElementById("miniRemoteVideo").srcObject;

  if (remoteVideo.classList.contains("pip")) {
    remoteVideo.classList.remove("pip-mini");
    remoteVideo.classList.add("pip-normal");   
  }
  resetVideoLayout();
});

let isVideoMinimized = false;

function minimizeVideoCall() {
  if (!localStream) return;

  isVideoMinimized = true;

  document.getElementById("videoScreen").style.display = "none";

  const miniContainer = document.getElementById("miniLocalVideoContainer");
  const miniVideo     = document.getElementById("miniLocalVideo");

  miniVideo.srcObject = localStream;
  miniVideo.play().catch(e => console.log("Mini play error:", e));

  miniContainer.style.display = "block";

  showToast("Video call diminimalkan â€¢ chat dibuka kembali");
}

function updateVideoCallButton() {
  const btn = document.getElementById("videoCallBtn");
  if (!btn) return;

  if (isInVideoCall) {
    // Sedang video call â†’ DISABLE
    btn.classList.add("disabled");
    btn.style.opacity = "0.4";
    btn.style.cursor = "not-allowed";
    btn.title = "Sedang dalam panggilan video";
    btn.onclick = null; // nonaktifkan klik
  } else {
    // Tidak ada video call â†’ ENABLE
    btn.classList.remove("disabled");
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    btn.title = "Mulai video call";
    btn.onclick = callUser; // aktifkan kembali fungsi call
  }
}

function restoreVideoCall() {
  if (!isVideoMinimized) return;

  isVideoMinimized = false;

  document.getElementById("miniLocalVideoContainer").style.display = "none";
  document.getElementById("videoScreen").style.display = "flex";

  document.getElementById("localVideo").srcObject = localStream;

  showToast("Kembali ke mode video penuh");
}

document.getElementById("miniLocalVideoContainer")?.addEventListener("click", restoreVideoCall);

document.getElementById("localVideo").onclick = function() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = !isPipSwapped;

  if (isPipSwapped) {
    local.classList.remove("pip");
    local.classList.add("full");
    remote.classList.remove("full");
    remote.classList.add("pip");
  } else {
    local.classList.remove("full");
    local.classList.add("pip");
    remote.classList.remove("pip");
    remote.classList.add("full");

    local.style.transform  = isFront ? "scaleX(-1)" : "none";
    remote.style.transform = "none";
  }

  local.style.zIndex  = isPipSwapped ? "5"  : "10";
  remote.style.zIndex = isPipSwapped ? "10" : "5";

  updateMicIcons();
};

let pendingDeleteMsgId = null;
let pendingDeleteBubble = null;
let pendingDeleteAction = null;

function openDeleteConfirm(msgId, bubbleElement, actionElement) {
  pendingDeleteMsgId = msgId;
  pendingDeleteBubble = bubbleElement;
  pendingDeleteAction = actionElement;

  if (actionElement) actionElement.style.display = 'block';

  document.getElementById("deleteConfirmModal").style.display = "grid";
}

function closeDeleteModal() {
  if (pendingDeleteAction) {
    pendingDeleteAction.style.display = 'none';
  }

  pendingDeleteMsgId = null;
  pendingDeleteBubble = null;
  pendingDeleteAction = null;
  document.getElementById("deleteConfirmModal").style.display = "none";
}

function confirmDelete() {
  if (!pendingDeleteMsgId) {
    closeDeleteModal();
    return;
  }

  if (pendingDeleteBubble) {
    pendingDeleteBubble.innerHTML = 'Pesan ini telah dihapus';
    pendingDeleteBubble.className = 'bubble deleted-msg';
  }

  if (pendingDeleteAction) {
    pendingDeleteAction.remove();
  }

  socket.emit('delete-for-everyone', { msgId: pendingDeleteMsgId });

  showToast("Pesan dihapus");

  closeDeleteModal();
}

function showToast(msg) {
  const t = document.getElementById("actionToast");
  t.textContent = msg;
  t.style.opacity = "1";
  t.style.transform = "translateX(-50%) translateY(0)";
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateX(-50%) translateY(20px)";
  }, 2800);
}

function showAlert(text) {
  document.getElementById("alertText").textContent = text;
  document.getElementById("alertModal").style.display = "grid";
}

function closeAlert() {
  document.getElementById("alertModal").style.display = "none";
}

function showLoginForm() {
  document.getElementById("welcomeContent").style.display = "none";
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("name").focus();
}

let viewOnceTimer = null;
let viewOnceInterval = null;

function startViewOnceTimer() {
  const countdownEl    = document.getElementById("voCountdown");
  const progressFill   = document.getElementById("voProgressFill");
  const timerContainer = document.getElementById("voTimerContainer");
  const expiredOverlay = document.getElementById("voExpiredOverlay");
  const img            = document.getElementById("voFullImage");

  // Cek apakah elemen ada dan ini benar-benar view-once
  if (!timerContainer || !countdownEl || !progressFill || !expiredOverlay || !img) {
    console.warn("Timer view-once tidak bisa dijalankan: elemen tidak ditemukan");
    return;
  }

  if (img.dataset.isViewonce !== 'true') {
    console.log("Bukan view-once â†’ timer dilewati");
    return;
  }

  // Reset semua state sebelum mulai
  clearInterval(viewOnceInterval);
  timerContainer.style.display = 'block';          // Paksa muncul SEGERA
  expiredOverlay.style.display = 'none';
  img.classList.remove('expired');
  progressFill.style.width = '0%';

  let remaining = 15;
  countdownEl.textContent = remaining;

  console.log("Timer view-once dimulai: " + remaining + " detik");

  viewOnceInterval = setInterval(() => {
    remaining--;
    countdownEl.textContent = remaining;

    // Update progress bar (0% â†’ 100%)
    const percent = ((15 - remaining) / 15) * 100;
    progressFill.style.width = percent + '%';

    if (remaining <= 0) {
      clearInterval(viewOnceInterval);
      timerContainer.style.display = 'none';
      expiredOverlay.style.display = 'flex';
      img.classList.add('expired');
      console.log("Timer habis â†’ mode expired aktif");
    }
  }, 1000);
}

function closeViewOnce() {
  const modal          = document.getElementById("viewOnceModal");
  const img            = document.getElementById("voFullImage");
  const timerContainer = document.getElementById("voTimerContainer");
  const expiredOverlay = document.getElementById("voExpiredOverlay");

  clearInterval(viewOnceInterval);

  if (timerContainer) timerContainer.style.display = "none";
  if (expiredOverlay) expiredOverlay.style.display = "none";
  if (img) {
    img.classList.remove("expired");
    img.src = "";
  }

  modal.style.display = "none";
  document.getElementById("voHeader").textContent = "Foto dari ...";
}

function start() {
  const name   = document.getElementById("name").value.trim()   || "Anonim";
  const age    = document.getElementById("age").value;
  const gender = document.getElementById("gender").value;
  const job    = document.getElementById("job").value;
  const server = document.getElementById("server").value;

  window.userData = { name, age, gender, job, server };
  socket.emit("join", { name, age, gender, job, server });

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("searching").style.display = "flex";
}

document.addEventListener('click', function(e) {
  const wrapper = e.target.closest('.view-once-wrapper, .normal-image-wrapper');
  if (!wrapper) return;

  const src       = wrapper.dataset.src;
  const fromName  = wrapper.dataset.from;
  const isViewOnce = wrapper.dataset.isViewonce === 'true';

  if (!src) return;

  const headerText = `Gambar dari ${fromName}`;
  document.getElementById('voHeader').textContent = headerText;

  const modal          = document.getElementById('viewOnceModal');
  const img            = document.getElementById('voFullImage');
  const timerContainer = document.getElementById('voTimerContainer');
  const expiredOverlay = document.getElementById('voExpiredOverlay');

  // Reset paksa sebelum buka modal
  if (timerContainer) timerContainer.style.display = 'none';
  if (expiredOverlay) expiredOverlay.style.display = 'none';
  img.classList.remove('expired');

  img.src = src;
  img.dataset.isViewonce = isViewOnce ? 'true' : 'false';

  modal.style.display = 'flex';

  // Reset expired state
  if (expiredOverlay) expiredOverlay.style.display = 'none';

  if (isViewOnce) {
    // Tidak perlu blur thumbnail lagi karena sudah jelas di chat

    // Paksa tampilkan timer SEGERA
    if (timerContainer) {
      timerContainer.style.display = 'block';  // langsung tampil di bawah gambar
    }

    // Mulai timer
    startViewOnceTimer();
  } else {
    // Untuk gambar biasa â†’ pastikan timer & expired benar-benar hilang
    if (timerContainer) timerContainer.style.display = 'none';
    if (expiredOverlay) expiredOverlay.style.display = 'none';
  }
});

function addMsg(data, side, time = timeNow()) {
  const div = document.createElement("div");
  div.className = `msg ${side}`;

  let msgId = data.id;
  if (msgId) {
    div.dataset.msgId = msgId;
    messagesMap[msgId] = div;
  } else {
    const tempId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    div.dataset.msgId = tempId;
    messagesMap[tempId] = div;
  }

  let content = '';

  if (data.type === 'text' || !data.type) {
    content = `<div class="bubble">${(data.text || '').replace(/\n/g, '<br>')}</div>`;
  } 
  else if (data.type === 'file') {
    const isViewOnce = data.viewOnce === true;
    const icon = isViewOnce ? 'bi bi-hourglass-split' : 'bi bi-image';
    const label = isViewOnce ? 'Foto sekali lihat' : 'Foto';

    content = `
      <div class="bubble ${isViewOnce ? 'view-once' : ''}">
        <div class="image-placeholder">
          <i class="${icon}"></i>
          <span class="view-once-label">${label}</span>
        </div>
        ${data.caption ? `<p style="margin-top:8px; font-size:0.9rem; opacity:0.9;">${data.caption}</p>` : ''}
      </div>`;

    // Simpan data penting ke div untuk dibuka nanti
    div.dataset.fileUrl = data.fileUrl || '';
    div.dataset.isViewonce = isViewOnce ? 'true' : 'false';
    div.dataset.fromName = data.fromName || (side === 'me' ? (window.userData?.name || 'Kamu') : (partner?.name || 'Partner'));
    div.dataset.caption = data.caption || '';
  } 
  else if (data.type === 'deleted') {
    content = `<div class="bubble deleted-msg">Pesan ini telah dihapus</div>`;
  }

  div.innerHTML = `
    ${content}
    <div class="time">${time}</div>
  `;

  // Tombol hapus untuk pesan saya
  if (side === 'me' && data.type !== 'deleted') {
    const action = document.createElement('div');
    action.className = 'msg-action';
    action.textContent = 'Hapus';
    action.style.display = 'none';

    action.onclick = (e) => {
      e.stopPropagation();
      const currentMsgId = div.dataset.msgId;

      if (currentMsgId.startsWith('temp-')) {
        showToast("Pesan belum terkirim ke server");
        return;
      }

      const bubble = div.querySelector('.bubble');
      openDeleteConfirm(currentMsgId, bubble, action);
    };

    div.appendChild(action);
    setupInteractionForDelete(div, action);
  }

  // Event klik untuk membuka gambar
  if (data.type === 'file' && div.dataset.fileUrl) {
    div.style.cursor = 'pointer';
    div.addEventListener('click', function openImageModal(e) {
      // Jika view-once dan sudah dilihat â†’ blokir
      if (div.dataset.isViewonce === 'true' && div.classList.contains('viewed')) {
        showToast("Gambar ini sudah dilihat");
        return;
      }

      const fileUrl = div.dataset.fileUrl;
      const isViewOnce = div.dataset.isViewonce === 'true';
      const fromName = div.dataset.fromName;

      if (!fileUrl) {
        showToast("Gambar tidak tersedia");
        return;
      }

      const headerText = `Gambar dari ${fromName}`;
      document.getElementById('voHeader').textContent = headerText;

      const modal = document.getElementById('viewOnceModal');
      const img = document.getElementById('voFullImage');
      const timerContainer = document.getElementById('voTimerContainer');
      const expiredOverlay = document.getElementById('voExpiredOverlay');

      // Reset modal sebelum buka
      if (timerContainer) timerContainer.style.display = 'none';
      if (expiredOverlay) expiredOverlay.style.display = 'none';
      img.classList.remove('expired');

      img.src = fileUrl;
      img.dataset.isViewonce = isViewOnce ? 'true' : 'false';

      modal.style.display = 'flex';

      if (isViewOnce) {
        // Tampilkan timer langsung
        if (timerContainer) timerContainer.style.display = 'block';
        startViewOnceTimer();

        // Tandai bubble sebagai sudah dilihat â†’ gelap + ubah teks label jadi "Dilihat"
        div.classList.add('viewed');
        const labelEl = div.querySelector('.view-once-label');
        if (labelEl) labelEl.textContent = 'Dilihat';
      }
    });
  }

  const messagesContainer = document.getElementById("messages");
  messagesContainer.appendChild(div);
  div.scrollIntoView({ behavior: "smooth", block: "end" });

  return div;
}

function timeNow() {
  const d = new Date();
  const hours   = d.getHours().toString().padStart(2, "0");
  const minutes = d.getMinutes().toString().padStart(2, "0");
  return hours + ":" + minutes;
}

function sendMessage() {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text || !partner) return;

  addMsg({ type: 'text', text }, "me");

  socket.emit("message", { type: 'text', text });

  input.value = "";
  input.focus();
}

function previewFile() {
  selectedFile = document.getElementById('fileInput').files[0];
  if (!selectedFile) return;

  const previewImg = document.getElementById('previewImage');
  const isImage = selectedFile.type.startsWith('image/');

  if (isImage) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';
      document.getElementById('filePreviewModal').style.display = 'grid';
    };
    reader.readAsDataURL(selectedFile);
  } else {

    previewImg.src = ''; 
    previewImg.style.display = 'none';

    showAlert("Preview hanya mendukung gambar");
    document.getElementById('filePreviewModal').style.display = 'grid';
  }
}

async function sendFile() {
  if (!selectedFile || !partner) {
    showAlert("Tidak ada file yang dipilih");
    return;
  }

  const caption = document.getElementById('captionInput').value.trim();
  const viewOnce = document.getElementById('viewOnceCheckbox').checked;

  const CLOUD_NAME    = "davgb7tjm";      
  const UPLOAD_PRESET = "sanz-chat";  

  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("upload_preset", UPLOAD_PRESET);

  try {

    showToast("Sedang mengirim...");

    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: "POST",
      body: formData
    });

    if (!response.ok) {
      const errData = await response.json();
      throw new Error(errData.error?.message || `Upload gagal (HTTP ${response.status})`);
    }

    const data = await response.json();

    if (!data.secure_url && !data.url) {
      throw new Error("Tidak mendapatkan URL gambar dari Cloudinary");
    }

    const imageUrl = data.secure_url || data.url;

    addMsg({
      type: 'file',
      fileUrl: imageUrl,
      caption: caption || undefined,
      viewOnce: viewOnce,
      fromName: window.userData?.name || "Anonim" 
    }, "me");

    socket.emit("message", {
      type: 'file',
      fileUrl: imageUrl,
      caption: caption || null,
      viewOnce: viewOnce,
      fromName: window.userData?.name || "Anonim"
    });

    showToast(viewOnce ? "Gambar terkirim!" : "Gambar terkirim!");

  } catch (err) {
    console.error("Gagal upload ke Cloudinary:", err);
    showAlert("Gagal mengirim gambar:\n" + (err.message || "Cek koneksi"));
  }

  cancelFilePreview();

  document.getElementById('fileInput').value = '';
}

function cancelFilePreview() {
  selectedFile = null;
  document.getElementById('previewImage').style.display = 'none';
  document.getElementById('captionInput').value = '';
  document.getElementById('viewOnceCheckbox').checked = false;
  document.getElementById('filePreviewModal').style.display = 'none';
}

function setupInteractionForDelete(msgElement, actionElement) {
  let pressTimer;

  msgElement.addEventListener('touchstart', () => {
    pressTimer = setTimeout(() => {
      msgElement.classList.add('long-press');
      actionElement.style.display = 'block';
    }, 500); 
  });

  msgElement.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
    setTimeout(() => {
      msgElement.classList.remove('long-press');
      actionElement.style.display = 'none'; 
    }, 3000); 
  });

  msgElement.addEventListener('touchmove', () => {
    clearTimeout(pressTimer);
    msgElement.classList.remove('long-press');
    actionElement.style.display = 'none';
  });

  msgElement.addEventListener('click', (e) => {

    if (e.target === actionElement || actionElement.contains(e.target)) return;

    if (msgElement.classList.contains('clicked')) {
      msgElement.classList.remove('clicked');
      actionElement.style.display = 'none';
    } else {
      msgElement.classList.add('clicked');
      actionElement.style.display = 'block';
    }
  });
}

function deleteForEveryone(msgId) {
  if (!msgId || msgId.startsWith('temp-')) {
    showToast("Pesan belum terkirim ke server");
    return;
  }

  socket.emit('delete-for-everyone', { msgId });
  updateMsgAsDeleted(msgId); 
}

function updateMsgAsDeleted(msgId) {
  const msgDiv = messagesMap[msgId];
  if (msgDiv) {

    const bubble = msgDiv.querySelector('.bubble');
    if (bubble) {
      bubble.innerHTML = 'Pesan ini telah dihapus';
      bubble.className = 'bubble deleted-msg';
    }

    const action = msgDiv.querySelector('.msg-action');
    if (action) action.remove();

    const timeEl = msgDiv.querySelector('.time');
    if (timeEl) timeEl.textContent = timeNow();
  } else {
    console.warn(`Pesan dengan ID ${msgId} tidak ditemukan saat dihapus`);
  }
}

socket.on("matched", p => {
    partner = p;
    document.getElementById("searching").style.display = "none";
    document.getElementById("chat").style.display = "flex";
    document.getElementById("messages").innerHTML = "";
    document.getElementById("partnerName").textContent = p.name;
    document.getElementById("partnerStatus").textContent = "Online";
    document.getElementById("partnerStatus").className = "partner-status status-online";
    document.getElementById("msg").disabled = false;
    document.querySelector(".footer button").disabled = false;
    document.getElementById("refreshBtn").style.display = "none";

    // â”€â”€ Tambahkan ini â”€â”€
    setPartnerButtonsEnabled(true);

    isInVideoCall = false;
    updateVideoCallButton();          
});

socket.on("message", data => {
  const side = data.fromMe ? "me" : "other";  
  addMsg(data, side);
});

socket.on("delete-for-everyone", ({ msgId }) => updateMsgAsDeleted(msgId));

socket.on("typing", () => {
  const el = document.getElementById("partnerStatus");
  el.textContent = "Sedang mengetikâ€¦";
  el.className = "partner-status status-typing";
  clearTimeout(window.typingTm);
  window.typingTm = setTimeout(() => {
    el.textContent = "Online";
    el.className = "partner-status status-online";
  }, 2200);
});

document.getElementById("msg").oninput = () => socket.emit("typing");

socket.on("partner-left", () => {
    document.getElementById("partnerStatus").textContent = "Offline";
    document.getElementById("partnerStatus").className = "partner-status status-offline";
    document.getElementById("msg").disabled = true;
    document.querySelector(".footer button").disabled = true;
    document.getElementById("refreshBtn").style.display = "block";

    if (isInVideoCall) {
        showToast("Video call ditutup otomatis");
        endCall(true);
    }

    // â”€â”€ Tambahkan ini â”€â”€
    setPartnerButtonsEnabled(false);

    // Optional: reset tampilan tombol video call
    const btn = document.getElementById("videoCallBtn");
    btn.classList.remove("disabled");   // biar tidak kelihatan disabled
    btn.style.opacity = "1";            // pastikan tidak gelap
});

async function startMedia() {
  try {

    localStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "user",
        width: { ideal: 640 },
        height: { ideal: 480 },
        aspectRatio: { ideal: 4/3 }
      },
      audio: true
    });

    const videoTrack = localStream.getVideoTracks()[0];
    const audioTrack = localStream.getAudioTracks()[0];

    if (videoTrack) {
      videoTrack.enabled = myCamEnabled;  
    }

    if (audioTrack) {
      audioTrack.enabled = myMicEnabled;
    }

    document.getElementById("camBtn").className = 
      (videoTrack && videoTrack.enabled) 
        ? "bi bi-camera-video-fill" 
        : "bi bi-camera-video-off-fill muted";

    document.getElementById("micBtn").className = 
      myMicEnabled 
        ? "bi bi-mic-fill" 
        : "bi bi-mic-mute-fill muted";

    const localVideo = document.getElementById("localVideo");
    localVideo.srcObject = localStream;
    localVideo.play().catch(e => console.log("Play error:", e));

    socket.emit("media-status", { 
      mic: myMicEnabled,
      cam: myCamEnabled 
    });

    return true;
  } catch (err) {
    console.error("getUserMedia gagal:", err);
    showAlert("Tidak bisa akses kamera: " + err.message);
    return false;
  }
}

function createPeer() {
  if (pc) pc.close();
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      { urls: "stun:stun2.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = e => {
    if (e.candidate) {
      socket.emit("ice", e.candidate);
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE state changed:", pc.iceConnectionState);
    checkSignal();
    autoEndCallIfDisconnected(); // Panggil fungsi baru ini
  };

  pc.onconnectionstatechange = () => {
    console.log("Connection state changed:", pc.connectionState);
    checkSignal();
    autoEndCallIfDisconnected(); // Panggil fungsi baru ini
  };

  pc.ontrack = e => {
    console.log("Menerima track remote!");
    const rv = document.getElementById("remoteVideo");
    rv.srcObject = e.streams[0];
    rv.play().catch(err => console.log("Auto-play error:", err));
  };

  return pc;
}

function updateConnectionUI() {
  if (!pc) return;
  const st = pc.connectionState;
  if (st === "connected") {
    document.getElementById("netStatus").style.display = "flex";
  } else if (st === "disconnected" || st === "failed") {
    document.getElementById("netStatus").style.display = "none";
  }
}

async function updateLatency() {
  if (!pc) {
    console.log("[LATENCY] pc tidak ada â†’ skip update");
    document.getElementById("netLeft").textContent = "â€” ms";
    return;
  }

  if (pc.connectionState !== "connected") {
    console.log("[LATENCY] Skip update: state bukan connected (" + pc.connectionState + ")");
    document.getElementById("netLeft").textContent = "â€” ms";
    return;
  }

  console.log("[LATENCY] Mulai ambil stats RTC...");

  try {
    const stats = await pc.getStats();
    let rtt = -1;
    let foundAny = false;

    stats.forEach(report => {
      if (report.type === 'candidate-pair') {
        if (report.currentRoundTripTime !== undefined && report.currentRoundTripTime > 0) {
          if (report.nominated || report.selectedCandidatePairId || report.state === 'succeeded') {
            rtt = Math.round(report.currentRoundTripTime * 1000);
            foundAny = true;
            console.log("[LATENCY] Dapat RTT dari candidate-pair (nominated/succeeded):", rtt, "ms");
          }
        }
      }
    });

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'candidate-pair' && report.currentRoundTripTime > 0) {
          rtt = Math.round(report.currentRoundTripTime * 1000);
          foundAny = true;
          console.log("[LATENCY] Dapat RTT dari candidate-pair (fallback):", rtt, "ms");
        }
      });
    }

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'remote-inbound-rtp' && report.roundTripTime > 0) {
          rtt = Math.round(report.roundTripTime * 1000);
          foundAny = true;
          console.log("[LATENCY] Dapat RTT dari remote-inbound-rtp:", rtt, "ms");
        }
      });
    }

    const netLeft = document.getElementById("netLeft");
    const netPill = document.getElementById("netStatus");

    if (rtt > 0 && !isNaN(rtt)) {
      lastRTT = rtt;
      netLeft.textContent = `${lastRTT} ms`;
      console.log("[LATENCY] Sukses update UI â†’", lastRTT, "ms");

      netPill.style.color = '#34d399';
      netPill.style.borderColor = '#0f9d6e';

      if (lastRTT > 150) {
        netPill.style.color = '#f59e0b';
        netPill.style.borderColor = '#d97706';
      }
      if (lastRTT > 300) {
        netPill.style.color = '#ef4444';
        netPill.style.borderColor = '#b91c1c';
      }
    } else {
      netLeft.textContent = foundAny ? "â€” ms" : "No RTT";
      netPill.style.color = '#94a3b8';
      netPill.style.borderColor = '#475569';
      console.log("[LATENCY] RTT tidak ditemukan atau 0 â†’ tampil", netLeft.textContent);
    }
  } catch (err) {
    console.error("[LATENCY] Error saat getStats:", err.name, err.message);
    document.getElementById("netLeft").textContent = "Err";
    document.getElementById("netStatus").style.color = '#ef4444';
    document.getElementById("netStatus").style.borderColor = '#b91c1c';
  }
}

function checkSignal() {
  if (!pc) {
    console.log("[NET] pc tidak ada â†’ hide pill");
    document.getElementById("netStatus").style.display = "none";
    return;
  }

  const state = pc.connectionState;
  console.log("[NET] Connection state saat ini:", state);

  const netPill = document.getElementById("netStatus");

  if (state === "connected") {
    console.log("[NET] CONNECTED â†’ tampilkan pill & mulai latency");
    netPill.style.display = "flex";
    updateLatency();  
    clearInterval(window.latencyInterval);
    window.latencyInterval = setInterval(() => {
      console.log("[NET] Update latency interval...");
      updateLatency();
    }, 1000);  
  } else if (state === "connecting" || state === "new") {
    console.log("[NET] Connecting â†’ tampilkan 'Connecting...'");
    netPill.style.display = "flex";
    document.getElementById("netLeft").textContent = "Connecting...";
  } else {
    console.log("[NET] State lain (" + state + ") â†’ sembunyikan pill");
    netPill.style.display = "none";
    clearInterval(window.latencyInterval);
    document.getElementById("netLeft").textContent = "â€” ms";
    lastRTT = 0;
  }
}

async function callUser() {
  if (!partner) {
    showAlert("Belum ada yang terhubung!");
    return;
  }

  isInVideoCall = true;
  updateVideoCallButton();  // â† DISABLE tombol

  const waitingModal = document.getElementById("waitingModal");
  const waitingText = document.getElementById("waitingText");
  waitingText.textContent = "Menunggu " + (partner.name || "partner") + " menerima panggilan...";
  waitingModal.style.display = "grid";

  window.callTm = setTimeout(() => {
    if (waitingModal.style.display === "grid") {
      waitingModal.style.display = "none";
      showAlert("Panggilan tidak dijawab.");
      isInVideoCall = false;
      updateVideoCallButton();  // â† ENABLE kembali jika timeout
    }
  }, 30000);

  try {
    const hasMedia = await startMedia();
    if (!hasMedia) {
      waitingModal.style.display = "none";
      isInVideoCall = false;
      updateVideoCallButton();  // â† ENABLE kembali jika gagal
      return;
    }

    createPeer();

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
    });

    socket.emit("call-user");

  } catch (err) {
    console.error("Gagal memulai panggilan:", err);
    waitingModal.style.display = "none";
    isInVideoCall = false;
    updateVideoCallButton();  // â† ENABLE kembali jika error
    showAlert("Gagal memulai video call: " + err.message);
  }
}

socket.on("incoming-call", d => {
  document.getElementById("callerName").textContent = d.name;
  document.getElementById("incomingCall").style.display = "grid";
});

socket.on("call-accepted", async () => {
  console.log("[CALLER] Panggilan diterima oleh partner");

  clearTimeout(window.callTm);

  const waitingModal = document.getElementById("waitingModal");
  if (waitingModal) {
    waitingModal.style.display = "none";
  }

  callPending = false;

  try {

    if (!localStream) {
      const hasMedia = await startMedia();
      if (!hasMedia) {
        showAlert("Gagal mengakses kamera/mikrofon setelah panggilan diterima");
        return;
      }
    }

    createPeer();

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
      console.log("[CALLER] Track ditambahkan ke pc setelah accepted:", track.kind);
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("[CALLER] Offer dikirim setelah accepted");

    document.getElementById("videoScreen").style.display = "flex";
    document.getElementById("callName").textContent = partner?.name || "Partner";

    resetVideoLayout();
    checkSignal();

    showToast("Menghubungkan...");

  } catch (err) {
    console.error("[CALLER] Error setelah call-accepted:", err);
    showAlert("Gagal menghubungkan video call: " + err.message);

    if (waitingModal) waitingModal.style.display = "none";
    document.getElementById("videoScreen").style.display = "none";
    endCall(); 
  }
});

function resetVideoLayout() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = false;

  local.className  = "pip pip-normal";
  remote.className = "full";

  local.style.zIndex = "10";
  remote.style.zIndex = "5";

  local.classList.remove("pip-mini");
  remote.classList.remove("pip-mini");

  local.style.transform  = isFront ? "scaleX(-1)" : "none";
  remote.style.transform = "none";
}

socket.on("offer", async o => {
  if (!pc) createPeer();
  await pc.setRemoteDescription(o);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("answer", ans);
});

socket.on("answer", a => pc.setRemoteDescription(a));

socket.on("ice", c => pc?.addIceCandidate(new RTCIceCandidate(c)));

async function acceptCall() {
  document.getElementById("incomingCall").style.display = "none";

  const hasMedia = await startMedia();
  if (!hasMedia) return;

  createPeer();  

  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
    console.log("Track lokal ditambahkan ke pc:", track.kind); 
  });

  try {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("Offer dikirim dari penerima panggilan");

    isInVideoCall = true;
    updateVideoCallButton();  // â† DISABLE tombol

    document.getElementById("videoScreen").style.display = "flex";
    document.getElementById("callName").textContent = partner?.name || "Partner";

    resetVideoLayout();

  } catch (err) {
    console.error("Gagal membuat offer di acceptCall:", err);
    showAlert("Gagal memulai video call: " + err.message);
    isInVideoCall = false;
    updateVideoCallButton();  // â† ENABLE kembali jika gagal
    return;
  }

  socket.emit("accept-call");
}

function rejectCall() {
  document.getElementById("incomingCall").style.display = "none";
  socket.emit("reject-call");

  // Reset status jika ada pending call
  isInVideoCall = false;
  updateVideoCallButton();  // â† Pastikan tombol kembali enable
}

socket.on("call-rejected", () => {
  clearTimeout(window.callTm);
  document.getElementById("waitingModal").style.display = "none";
  document.getElementById("rejectedText").textContent = `${partner?.name || "Partner"} menolak panggilan.`;
  document.getElementById("rejectedModal").style.display = "grid";

  isInVideoCall = false;
  updateVideoCallButton();  // â† ENABLE tombol kembali
});

socket.on("media-status", (status) => {
  if (status.mic !== undefined) {
    partnerMicEnabled = status.mic;  
    updateMicIcons();
  }
});

function endCall(isAuto = false) {
  console.log(`endCall() dipanggil - ${isAuto ? 'OTOMATIS (disconnect)' : 'MANUAL (user klik)'}`);

  if (pc) {
    try {
      pc.close();
      console.log("PeerConnection berhasil ditutup");
    } catch (err) {
      console.error("Gagal close PeerConnection:", err);
    }
    pc = null;
  }

  if (localStream) {
    localStream.getTracks().forEach(track => {
      try {
        track.stop();
        console.log(`Track ${track.kind} dihentikan`);
      } catch (err) {
        console.error(`Gagal stop track ${track.kind}:`, err);
      }
    });
    localStream = null;
  }

  const videoScreen = document.getElementById("videoScreen");
  if (videoScreen) videoScreen.style.display = "none";

  const netStatus = document.getElementById("netStatus");
  if (netStatus) netStatus.style.display = "none";

  isInVideoCall = false;
  isPipSwapped = false;
  isVideoMinimized = false;
  isMinimizedToPartner = false;

  const miniContainer = document.getElementById("miniRemoteVideoContainer");
  if (miniContainer) miniContainer.style.display = "none";

  const miniVideo = document.getElementById("miniRemoteVideo");
  if (miniVideo) {
    miniVideo.srcObject = null;
    miniVideo.pause();
  }

  const micBtn = document.getElementById("micBtn");
  if (micBtn) {
    micBtn.className = myMicEnabled 
      ? "bi bi-mic-fill" 
      : "bi bi-mic-mute-fill muted";
  }

  const camBtn = document.getElementById("camBtn");
  if (camBtn) {
    camBtn.className = myCamEnabled 
      ? "bi bi-camera-video-fill" 
      : "bi bi-camera-video-off-fill muted";
  }

  const remoteMicOverlay = document.getElementById("micStatusRemote");
  if (remoteMicOverlay) remoteMicOverlay.classList.add("hidden");

  const localMicOverlay = document.getElementById("micStatusLocal");
  if (localMicOverlay) localMicOverlay.classList.add("hidden");

  // Update tombol video call â†’ kembali aktif
  updateVideoCallButton();

  if (isAuto) {
    showToast("Koneksi video terputus");
  } else {
    showToast("Panggilan video diakhiri");
  }

  socket.emit("end-call");

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  if (localVideo) localVideo.srcObject = null;
  if (remoteVideo) remoteVideo.srcObject = null;
}

function autoEndCallIfDisconnected() {
  if (!pc || !isInVideoCall) return;

  const state = pc.connectionState;
  const iceState = pc.iceConnectionState;

  if (
    state === "disconnected" ||
    state === "failed" ||
    state === "closed" ||
    iceState === "disconnected" ||
    iceState === "failed" ||
    iceState === "closed"
  ) {
    console.log("Koneksi terputus â†’ auto end call");
    showToast("Koneksi video terputus");
    endCall(true);
    updateVideoCallButton();  // Pastikan tombol kembali enable
  }
}

socket.on("end-call", endCall);

document.getElementById("localVideo").onclick = function() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = !isPipSwapped;

  if (isPipSwapped) {
    local.classList.remove("pip");
    local.classList.add("full");
    remote.classList.remove("full");
    remote.classList.add("pip");

  } else {
    local.classList.remove("full");
    local.classList.add("pip");
    remote.classList.remove("pip");
    remote.classList.add("full");

    local.style.transform  = isFront ? "scaleX(-1)" : "none";
    remote.style.transform = "none";

  }

  local.style.zIndex  = isPipSwapped ? "5"  : "10";
  remote.style.zIndex = isPipSwapped ? "10" : "5";
};

async function switchCamera() {
  if (!localStream) {
    showAlert("Kamera belum aktif");
    return;
  }

  try {

    const oldVideoTrack = localStream.getVideoTracks()[0];
    if (oldVideoTrack) {
      oldVideoTrack.stop();           
      localStream.removeTrack(oldVideoTrack); 
    }

    const mode = isFront ? "environment" : "user";
    isFront = !isFront; 

    const newConstraints = {
      video: {
        facingMode: { exact: mode },          
        width: { ideal: 640 },              
        height: { ideal: 480 },             
        aspectRatio: { ideal: 4/3 },           
        frameRate: { ideal: 30 }
      }
    };

    const newStream = await navigator.mediaDevices.getUserMedia(newConstraints);

    const newVideoTrack = newStream.getVideoTracks()[0];
    if (!newVideoTrack) {
      throw new Error("Tidak ada track video baru");
    }

    localStream.addTrack(newVideoTrack);

    const localVideo = document.getElementById("localVideo");
    
    localVideo.srcObject = null;
    await new Promise(resolve => setTimeout(resolve, 50)); 
    localVideo.srcObject = localStream;
    localVideo.play().catch(e => console.log("Play error:", e));

    if (pc) {
      const videoSender = pc.getSenders().find(s => s.track && s.track.kind === "video");
      if (videoSender) {
        await videoSender.replaceTrack(newVideoTrack);
        console.log("Track video berhasil diganti di peer connection");
      } else {
        console.warn("Tidak menemukan video sender");
      }
    }

    showToast(`Kamera ${isFront ? "depan" : "belakang"} aktif`);

  } catch (err) {
    console.error("Switch camera gagal:", err.name, err.message);
    showAlert("Gagal ganti kamera: " + (err.message || "Coba restart halaman"));

    isFront = !isFront;
  }
}

function closeViewOnce() {
  const modal          = document.getElementById("viewOnceModal");
  const img            = document.getElementById("voFullImage");
  const timerContainer = document.getElementById("voTimerContainer");
  const expiredOverlay = document.getElementById("voExpiredOverlay");

  clearInterval(viewOnceInterval);

  // Reset semua
  modal.classList.remove('view-once-active');
  if (timerContainer) timerContainer.style.display = "none";
  if (expiredOverlay) expiredOverlay.style.display = "none";
  if (img) {
    img.classList.remove("expired");
    img.src = "";
  }

  modal.style.display = "none";
  document.getElementById("voHeader").textContent = "Foto dari ...";
}

function toggleMic() {
  if (!localStream) return;
  const tr = localStream.getAudioTracks()[0];
  if (!tr) return;

  myMicEnabled = !myMicEnabled;
  tr.enabled = myMicEnabled;

  document.getElementById("micBtn").className = 
    myMicEnabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill muted";

  socket.emit("media-status", { mic: myMicEnabled });

  updateMicIcons();
}

function toggleCam() {
  if (!localStream) return;
  const tr = localStream.getVideoTracks()[0];
  if (!tr) return;

  myCamEnabled = !myCamEnabled;
  tr.enabled = myCamEnabled;

  document.getElementById("camBtn").className = 
    myCamEnabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill muted";
}

function openProfile() {
  if (!partner) return;

  const genderText = partner.gender && partner.gender !== "-" ? partner.gender : "Tidak disebutkan";
  const jobText    = partner.job    && partner.job    !== "-" ? partner.job    : "Tidak disebutkan";

  document.getElementById("profileContent").innerHTML = `
    <div><b>Nama:</b> ${partner.name}</div>
    <div><b>Umur:</b> ${partner.age}</div>
    <div><b>Gender:</b> ${genderText}</div>
    <div><b>Status:</b> ${jobText}</div>
    <div><b>Server:</b> ${partner.server}</div>
  `;
  document.getElementById("profileModal").style.display = "grid";
}

function closeProfile() { document.getElementById("profileModal").style.display = "none"; }
function closeRejected() { document.getElementById("rejectedModal").style.display = "none"; }

function refreshChat() {
  document.getElementById("chat").style.display = "none";
  document.getElementById("searching").style.display = "flex";
  if (window.userData) socket.emit("join", window.userData);
}

function logout() {
  socket.disconnect();
  location.reload();
}

document.getElementById('viewOnceModal').addEventListener('contextmenu', function(e) {
  if (e.target.closest('#voFullImage') || e.target === document.getElementById('voFullImage')) {
    e.preventDefault();
    return false;
  }
}, false);

document.getElementById('viewOnceModal').addEventListener('dragstart', function(e) {
  if (e.target.tagName === 'IMG') {
    e.preventDefault();
  }
}, false);

document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('contextmenu', e => {
    if (e.target.closest('.view-once-wrapper, .normal-image-wrapper')) {
      e.preventDefault();
      return false;
    }
  }, false);

  document.addEventListener('dragstart', e => {
    if (e.target.closest('.view-once-wrapper img, .normal-image-wrapper img')) {
      e.preventDefault();
    }
  });
});
</script>
</body>
</html>