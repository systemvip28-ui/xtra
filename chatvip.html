<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Random â€¢ Temuin Orang Baru</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    :root {
      --bg:        #0d1117;
      --surface:   #161b22;
      --surface-2: #1f2937;
      --accent:    #10b981;
      --accent-dark:#059669;
      --danger:    #ef4444;
      --warning:   #f59e0b;
      --success:   #10b981;
      --text:      #e2e8f0;
      --text-sec:  #94a3b8;
      --border:    #30363d;
      --me:        #065f46;
      --other:     #1e293b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .screen {
      height: 100dvh;
      display: grid;
      place-items: center;
      padding: 16px;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: var(--surface);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 28px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .logo-big {
      font-size: 3.8rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    h1, h2, h3 {
      text-align: center;
    }

    h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    h2 { margin-bottom: 1.5rem; }
    .subtitle {
      color: var(--text-sec);
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 1.8rem;
    }

    input, select, button {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: white;
      font-size: 1rem;
    }

    input::placeholder, select option:disabled {
      color: #64748b;
    }

    button {
      background: var(--accent);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-danger {
      background: var(--danger);
    }
    .btn-danger:hover {
      background: #dc2626;
    }
/* Tambahkan atau ganti di dalam <style> */

/* Pastikan .screen tetap full height & center */
.screen {
  height: 100dvh;
  display: flex;               /* ubah dari grid ke flex agar lebih fleksibel */
  justify-content: center;
  align-items: center;
  padding: 16px;
}

/* Container khusus untuk konten searching */
.searching-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.8rem;                 /* jarak antar elemen */
  text-align: center;
  max-width: 320px;
  width: 100%;
}


/* Teks utama */
.searching-text {
  font-size: 1.25rem;
  font-weight: 500;
  opacity: 0.95;
  color: var(--text);
}

/* Teks tambahan (misal night mode) */
.searching-subtext {
  font-size: 0.95rem;
  color: var(--text-sec);
  line-height: 1.4;
  margin-top: 0.5rem;
}

/* Optional: animasi fade-in halus saat muncul */
#searching {
  opacity: 0;
  transition: opacity 0.4s ease;
}

#searching[style*="display: flex"],
#searching[style*="display:block"] {
  opacity: 1;
}
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #2d3748;
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #chat {
      display: none;
      flex-direction: column;
      height: 100dvh;
    }

    .header {
      height: 64px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-weight: 500;
    }

    .partner-info {
      line-height: 1.3;
    }

    .partner-name {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .partner-status {
      font-size: 0.82rem;
      opacity: 0.8;
    }

    .status-online  { color: #34d399; }
    .status-offline { color: #f87171; }
    .status-typing  { color: #fbbf24; font-style: italic; }

    .encryption-info {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface-2);
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      color: var(--text-sec);
      gap: 6px;
    }

    .encryption-info i {
      font-size: 1rem;
      color: var(--success);
    }

    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 78%;
      display: flex;
      flex-direction: column;
      position: relative;
      user-select: none; /* Untuk long press */
    }

    .me   { align-self: flex-end; }
    .other { align-self: flex-start; }

    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 0.96rem;
      line-height: 1.4;
      word-break: break-word;
    }

    .me .bubble {
      background: var(--me);
      border-bottom-right-radius: 4px;
    }

    .other .bubble {
      background: var(--other);
      border-bottom-left-radius: 4px;
    }

    .time {
      font-size: 0.68rem;
      opacity: 0.6;
      margin-top: 3px;
      align-self: flex-end;
    }

    .file-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
    }

    .view-once {
      opacity: 0.7;
      font-style: italic;
    }

    .deleted-msg {
      font-style: italic;
      color: var(--text-sec);
    }

    .footer {
      padding: 12px 16px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .footer input {
      flex: 1;
      border-radius: 999px;
      padding: 12px 20px;
      border: none;
    }

    .footer button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      font-size: 1.4rem;
      display: grid;
      place-items: center;
      padding: 0;
    }

    .video-wrap {
      position: fixed;
      inset: 0;
      background: black;
      display: none;
      flex-direction: column;
      z-index: 100;
    }

    .video-header {
      height: 56px;
      background: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 1.05rem;
      backdrop-filter: blur(10px);
    }

    .video-body {
      flex: 1;
      position: relative;
      background: #000;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: all 0.4s ease;
    }

    /* PIP (picture-in-picture) style - KONSISTEN di semua kondisi */
    #localVideo.pip,
    #remoteVideo.pip {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px !important;
      height: 160px !important;
      border-radius: 16px;
      border: 3px solid rgba(255,255,255,0.25);
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
      background: black;
      object-fit: cover;
      cursor: pointer;
      z-index: 10;
    }

    /* Full screen style */
    #localVideo.full,
    #remoteVideo.full {
      position: static;
      width: 100% !important;
      height: 100% !important;
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      z-index: 5;
    }

    #localVideo {
      transform: scaleX(-1); /* mirror default untuk self-view */
    }

    .video-footer {
      height: 80px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
    }

    .video-footer i {
      font-size: 1.6rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .video-footer i:hover {
      background: rgba(255,255,255,0.15);
    }

    .video-footer i.muted {
      color: #fca5a5;
      background: rgba(239,68,68,0.18);
    }

    .video-footer .end-call {
      background: var(--danger);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      place-items: center;
      z-index: 200;
      backdrop-filter: blur(4px);
    }

    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .modal-box button {
      margin: 8px 0;
    }

    #actionToast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30,41,59,0.92);
      color: white;
      padding: 12px 24px;
      border-radius: 999px;
      font-size: 0.95rem;
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s, transform 0.4s;
      backdrop-filter: blur(10px);
    }

    .net-pill {
      background: rgba(30,41,59,0.85);
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      display: none;
      align-items: center;
      backdrop-filter: blur(10px);
      color: #34d399;
      border: 1px solid #0f9d6e;
    }

    .video-header .net-pill {
      margin-left: auto;
      align-self: center;
    }

    #filePreviewModal .preview-img {
      max-width: 100%;
      max-height: 200px;
      margin-bottom: 12px;
      border-radius: 8px;
    }

    #filePreviewModal .caption-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
    }

    #filePreviewModal .view-once-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 0.95rem;
    }

    .msg-action {
      position: absolute;
      top: -40px;
      right: 0;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      display: none;
      z-index: 10;
      cursor: pointer;
      color: var(--danger);
    }

    .msg:hover .msg-action {
      display: block;
    }
.card:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
    }

    .hidden {
      display: none !important;
    }
    @media (max-width: 500px) {
      .video-header .net-pill {
        padding: 4px 10px;
        font-size: 0.78rem;
      }
      #localVideo.pip, #remoteVideo.pip {
        width: 100px !important;
        height: 133px !important;
        bottom: 16px;
        right: 16px;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN / WELCOME -->
<div class="screen" id="loginScreen">
  <div id="welcomeContent">
    <div class="logo-big">ðŸ’¬</div>
    <h1>Chat Random</h1>
    <div class="subtitle">Ngobrol santai dengan orang baru</div>
    <button onclick="showLoginForm()">Mulai Sekarang</button>
  </div>

  <div class="card hidden" id="loginForm">
    <h2>Isi Data Diri</h2>

    <input id="name" placeholder="Nama (opsional)" autocomplete="off"/>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0 4px; font-weight:500; color:var(--text-sec)">
      <span>Umur</span>
      <span id="ageVal">21</span>
    </div>
    <input id="age" type="range" min="13" max="80" value="21" oninput="ageVal.innerText=this.value"/>

    <select id="gender">
      <option value="" disabled selected>Gender</option>
      <option>Laki-laki</option>
      <option>Perempuan</option>
    </select>

    <select id="job">
      <option value="" disabled selected>Status saat ini</option>
      <option>Sekolah / Kuliah</option>
      <option>Kerja</option>
      <option>Mencari kerja</option>
      <option>Lainnya</option>
    </select>

    <select id="server">
      <option value="server1">Server 1 (Utama)</option>
      <option value="server2">Server 2</option>
      <option value="server3">Server 3</option>
    </select>

    <button onclick="start()">Masuk Chat</button>
  </div>
</div>

<!-- SEARCHING -->
<div class="screen" id="searching" style="display:none; flex-direction:column; gap:1.5rem;">
  <div class="loader"></div>
  <div style="font-size:1.1rem; opacity:0.9">Mencari temen ngobrol...</div>
</div>

<!-- MAIN CHAT -->
<div id="chat">
  <div class="header">
    <div class="partner-info">
      <div class="partner-name" id="partnerName">Menghubungkan...</div>
      <div class="partner-status" id="partnerStatus">Online</div>
    </div>
    <div style="display:flex; gap:16px; font-size:1.4rem;">
      <i class="bi bi-arrow-clockwise" id="refreshBtn" onclick="refreshChat()" style="display:none; cursor:pointer"></i>
      <i class="bi bi-camera-video-fill" onclick="callUser()" id="videoCallBtn" style="cursor:pointer"></i>
      <i class="bi bi-person-circle" onclick="openProfile()" style="cursor:pointer"></i>
      <i class="bi bi-box-arrow-right" onclick="logout()" style="cursor:pointer; color:#f87171"></i>
    </div>
  </div>

  <div class="encryption-info">
    <i class="bi bi-lock-fill"></i>
    End-to-end encrypted
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Ketik pesan..." autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage()"/>
    <button onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
    <input type="file" id="fileInput" style="display:none;" onchange="previewFile()"/>
    <button onclick="sendMessage()">âž¤</button>
  </div>
</div>

<!-- VIDEO CALL INTERFACE -->
<div id="videoScreen" class="video-wrap">
  <div class="video-header">
    <span id="callName">Video Call</span>
    <div class="net-pill" id="netStatus">
      <span id="netLeft">â€” ms</span>
    </div>
  </div>

  <div class="video-body">
    <video id="remoteVideo" autoplay playsinline class="full"></video>
    <video id="localVideo" autoplay muted playsinline class="pip"></video>
  </div>

  <div class="video-footer">
    <i id="micBtn"   class="bi bi-mic-fill"        onclick="toggleMic()"></i>
    <i id="camBtn"   class="bi bi-camera-video-fill" onclick="toggleCam()"></i>
    <i class="bi bi-arrow-repeat" onclick="switchCamera()"></i>
    <i class="bi bi-telephone-x-fill end-call" onclick="endCall()"></i>
  </div>
</div>

<!-- MODALS -->
<div id="incomingCall" class="modal">
  <div class="modal-box">
    <h3>Panggilan Video Masuk</h3>
    <p id="callerName" style="margin:1rem 0; font-size:1.1rem"></p>
    <button onclick="acceptCall()">Terima</button>
    <button class="btn-danger" onclick="rejectCall()">Tolak</button>
  </div>
</div>

<div id="rejectedModal" class="modal">
  <div class="modal-box">
    <div style="font-size:3rem; color:var(--danger); margin-bottom:1rem;">âœ–</div>
    <p id="rejectedText" style="margin-bottom:1.5rem"></p>
    <button onclick="closeRejected()">Tutup</button>
  </div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-box" style="text-align:left">
    <h3>Profil Partner</h3>
    <div id="profileContent" style="margin:1.2rem 0; line-height:1.7; color:var(--text-sec)"></div>
    <button onclick="closeProfile()">Tutup</button>
  </div>
</div>

<div id="waitingModal" class="modal">
  <div class="modal-box">
    <div class="loader" style="margin:0 auto 1.5rem"></div>
    <p id="waitingText">Menunggu partner menerima...</p>
  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box">
    <p id="alertText" style="margin-bottom:1.5rem; font-size:1rem"></p>
    <button onclick="closeAlert()">OK</button>
  </div>
</div>

<div id="filePreviewModal" class="modal" style="display:none;">
  <div class="modal-box">
    <h3>Pratinjau File</h3>
    <img id="previewImage" class="preview-img" style="display:none;"/>
    <input id="captionInput" class="caption-input" placeholder="Tambahkan caption (opsional)"/>
    <label class="view-once-checkbox">
      <input type="checkbox" id="viewOnceCheckbox"/>
      Kirim sebagai sekali lihat
    </label>
    <button onclick="sendFile()">Kirim</button>
    <button class="btn-danger" onclick="cancelFilePreview()">Batal</button>
  </div>
</div>

<div id="actionToast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const socket = io("https://chat-jsb8.onrender.com");

let partner = null;
let pc, localStream;
let isFront = true;
let isPipSwapped = false;
let callPending = false;
let lastRTT = 0;
let selectedFile = null;
let messageIdCounter = 0; // Untuk assign ID unik ke pesan
let messagesMap = {}; // Map pesan berdasarkan ID untuk delete

const ice = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function showToast(msg) {
  const t = document.getElementById("actionToast");
  t.textContent = msg;
  t.style.opacity = "1";
  t.style.transform = "translateX(-50%) translateY(0)";
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateX(-50%) translateY(20px)";
  }, 2800);
}

function showAlert(text) {
  document.getElementById("alertText").textContent = text;
  document.getElementById("alertModal").style.display = "grid";
}

function closeAlert() {
  document.getElementById("alertModal").style.display = "none";
}

// â”€â”€â”€ Login Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoginForm() {
  document.getElementById("welcomeContent").style.display = "none";
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("name").focus();
}

function start() {
  const name   = document.getElementById("name").value.trim()   || "Anon";
  const age    = document.getElementById("age").value;
  const gender = document.getElementById("gender").value;
  const job    = document.getElementById("job").value;
  const server = document.getElementById("server").value;

  if (!gender || !job) {
    showAlert("Gender dan Status wajib diisi!");
    return;
  }

  window.userData = { name, age, gender, job, server };
  socket.emit("join", { name, age, gender, job, server });

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("searching").style.display = "flex";
}

// â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMsg(data, side, time = timeNow()) {
  const div = document.createElement("div");
  div.className = `msg ${side}`;
  div.dataset.msgId = data.id; // Simpan ID pesan
  messagesMap[data.id] = div;

  let content = '';
  if (data.type === 'text') {
    content = `<div class="bubble">${data.text}</div>`;
  } else if (data.type === 'file') {
    content = `<div class="bubble">
                 <img src="${data.fileUrl}" class="file-preview" alt="File"/>
                 ${data.caption ? `<p>${data.caption}</p>` : ''}
               </div>`;
    if (data.viewOnce) {
      div.classList.add('view-once');
      // Asumsi auto-delete setelah dilihat, emit ke server
      setTimeout(() => socket.emit('delete-for-everyone', { msgId: data.id }), 5000); // Contoh delay 5s
    }
  } else if (data.type === 'deleted') {
    content = `<div class="bubble deleted-msg">Pesan ini telah dihapus</div>`;
  }

  div.innerHTML = `
    ${content}
    <div class="time">${time}</div>
  `;
  if (side === 'me') {
    const action = document.createElement('div');
    action.className = 'msg-action';
    action.textContent = 'Hapus untuk semua';
    action.onclick = () => deleteForEveryone(data.id);
    div.appendChild(action);
    setupLongPress(div, action);
  }

  document.getElementById("messages").appendChild(div);
  div.scrollIntoView({ behavior: "smooth", block: "end" });
}

function timeNow() {
  const d = new Date();
  return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
}

function sendMessage() {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text || !partner) return;

  const msgId = ++messageIdCounter;
  socket.emit("message", { id: msgId, type: 'text', text });
  addMsg({ id: msgId, type: 'text', text }, "me");
  input.value = "";
  input.focus();
}

function previewFile() {
  selectedFile = document.getElementById('fileInput').files[0];
  if (!selectedFile) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('previewImage').src = e.target.result;
    document.getElementById('previewImage').style.display = 'block';
    document.getElementById('filePreviewModal').style.display = 'grid';
  };
  reader.readAsDataURL(selectedFile);
}

function sendFile() {
  if (!selectedFile || !partner) return;

  const caption = document.getElementById('captionInput').value.trim();
  const viewOnce = document.getElementById('viewOnceCheckbox').checked;

  const formData = new FormData();
  formData.append('file', selectedFile);

  console.log('Mulai upload ke: /upload');
  console.log('Nama file:', selectedFile.name, 'Ukuran:', selectedFile.size);

  fetch('/upload', {
    method: 'POST',
    body: formData
  })
  .then(async res => {
    console.log('Status respons:', res.status, res.statusText);
    console.log('Headers:', [...res.headers.entries()]);

    const text = await res.text();  // ambil dulu sebagai text (aman)
    console.log('Respons mentah (potongan):', text.substring(0, 300));

    if (!res.ok) {
      throw new Error(`Server error ${res.status} - ${text.substring(0, 100)}...`);
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error('Gagal parse JSON. Respons bukan JSON:', text.substring(0, 200));
      throw new Error('Server mengembalikan bukan JSON (mungkin HTML error page)');
    }

    if (!data.url) {
      throw new Error('Respons JSON tidak punya field "url"');
    }

    const msgId = ++messageIdCounter;
    socket.emit("message", { id: msgId, type: 'file', fileUrl: data.url, caption, viewOnce });
    addMsg({ id: msgId, type: 'file', fileUrl: data.url, caption, viewOnce }, "me");
  })
  .catch(err => {
    console.error('Upload error lengkap:', err);
    showAlert('Gagal upload: ' + err.message);
  });

  cancelFilePreview();
}

function cancelFilePreview() {
  selectedFile = null;
  document.getElementById('previewImage').style.display = 'none';
  document.getElementById('captionInput').value = '';
  document.getElementById('viewOnceCheckbox').checked = false;
  document.getElementById('filePreviewModal').style.display = 'none';
}

function setupLongPress(msgElement, actionElement) {
  let pressTimer;
  msgElement.addEventListener('touchstart', () => {
    pressTimer = setTimeout(() => actionElement.style.display = 'block', 500);
  });
  msgElement.addEventListener('touchend', () => clearTimeout(pressTimer));
  msgElement.addEventListener('touchmove', () => clearTimeout(pressTimer));
}

function deleteForEveryone(msgId) {
  socket.emit('delete-for-everyone', { msgId });
  updateMsgAsDeleted(msgId);
}

function updateMsgAsDeleted(msgId) {
  const msgDiv = messagesMap[msgId];
  if (msgDiv) {
    msgDiv.innerHTML = `
      <div class="bubble deleted-msg">Pesan ini telah dihapus</div>
      <div class="time">${timeNow()}</div>
    `;
  }
}

socket.on("matched", p => {
  partner = p;
  document.getElementById("searching").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
  document.getElementById("partnerName").textContent = p.name;
  document.getElementById("partnerStatus").textContent = "Online";
  document.getElementById("partnerStatus").className = "partner-status status-online";
  document.getElementById("msg").disabled = false;
  document.querySelector(".footer button").disabled = false;
  document.getElementById("refreshBtn").style.display = "none";
  document.getElementById("videoCallBtn").style.display = "block";
});

socket.on("message", data => addMsg(data, "other"));

socket.on("delete-for-everyone", ({ msgId }) => updateMsgAsDeleted(msgId));

socket.on("typing", () => {
  const el = document.getElementById("partnerStatus");
  el.textContent = "Sedang mengetikâ€¦";
  el.className = "partner-status status-typing";
  clearTimeout(window.typingTm);
  window.typingTm = setTimeout(() => {
    el.textContent = "Online";
    el.className = "partner-status status-online";
  }, 2200);
});

document.getElementById("msg").oninput = () => socket.emit("typing");

socket.on("partner-left", () => {
  document.getElementById("partnerStatus").textContent = "Offline";
  document.getElementById("partnerStatus").className = "partner-status status-offline";
  document.getElementById("msg").disabled = true;
  document.querySelector(".footer button").disabled = true;
  document.getElementById("refreshBtn").style.display = "block";
});

// â”€â”€â”€ Video Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: true
    });
    document.getElementById("localVideo").srcObject = localStream;
  } catch (err) {
    console.error("getUserMedia gagal:", err);
    showAlert("Tidak bisa akses kamera/mikrofon: " + err.message);
    return false;  // penting: return false kalau gagal
  }
  return true;
}

function createPeer() {
  if (pc) pc.close();
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      { urls: "stun:stun2.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = e => {
    if (e.candidate) {
      console.log("Kirim ICE candidate");
      socket.emit("ice", e.candidate);
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE state:", pc.iceConnectionState);
    checkSignal();  // â† tambahkan ini
  };

  pc.onconnectionstatechange = () => {
    console.log("Connection state:", pc.connectionState);
    checkSignal();  // â† tambahkan ini (paling penting)

    if (pc.connectionState === "connected") {
      console.log("WebRTC CONNECTED!");
      // Bisa tambah toast kalau mau: showToast("Koneksi video stabil!");
    } else if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
      console.log("WebRTC gagal/terputus");
      showToast("Koneksi video terputus");
    }
  };

  pc.ontrack = e => {
    console.log("Menerima track remote!");
    const rv = document.getElementById("remoteVideo");
    rv.srcObject = e.streams[0];
    rv.play().catch(err => console.log("Auto-play error:", err));
  };

  return pc;
}

function updateConnectionUI() {
  if (!pc) return;
  const st = pc.connectionState;
  if (st === "connected") {
    document.getElementById("netStatus").style.display = "flex";
  } else if (st === "disconnected" || st === "failed") {
    document.getElementById("netStatus").style.display = "none";
  }
}

async function updateLatency() {
  if (!pc || pc.connectionState !== "connected") return;

  try {
    const stats = await pc.getStats();
    let rtt = -1;

    stats.forEach(report => {
      if (report.type === 'candidate-pair' &&
          (report.nominated || report.selectedOrState === 'selected' || report.state === 'succeeded') &&
          report.currentRoundTripTime !== undefined &&
          report.currentRoundTripTime > 0) {
        rtt = Math.round(report.currentRoundTripTime * 1000);
      }
    });

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'candidate-pair' && report.currentRoundTripTime > 0) {
          rtt = Math.round(report.currentRoundTripTime * 1000);
        }
      });
    }

    if (rtt === -1) {
      stats.forEach(report => {
        if (report.type === 'remote-inbound-rtp' && report.roundTripTime > 0) {
          rtt = Math.round(report.roundTripTime * 1000);
        }
      });
    }

    const netLeft = document.getElementById("netLeft");
    const netPill = document.getElementById("netStatus");

    if (rtt > 0 && !isNaN(rtt)) {
      lastRTT = rtt;
      netLeft.textContent = `${lastRTT} ms`;

      netPill.style.color = '#34d399';
      netPill.style.borderColor = '#0f9d6e';

      if (lastRTT > 150) {
        netPill.style.color = '#f59e0b';
        netPill.style.borderColor = '#d97706';
      }
      if (lastRTT > 300) {
        netPill.style.color = '#ef4444';
        netPill.style.borderColor = '#b91c1c';
      }
    } else {
      netLeft.textContent = "â€” ms";
      netPill.style.color = '#94a3b8';
      netPill.style.borderColor = '#475569';
    }
  } catch (err) {
    console.error("getStats error:", err);
    document.getElementById("netLeft").textContent = "Err";
  }
}

function checkSignal() {
  if (!pc) {
    document.getElementById("netStatus").style.display = "none";
    return;
  }

  const state = pc.connectionState;
  const netPill = document.getElementById("netStatus");

  if (state === "connected") {
    netPill.style.display = "flex";           // â† ini yang bikin pill muncul!
    updateLatency();                          // update pertama kali
    clearInterval(window.latencyInterval);
    window.latencyInterval = setInterval(updateLatency, 1500); // update setiap 1.5 detik
  } else if (state === "connecting" || state === "new") {
    netPill.style.display = "flex";
    document.getElementById("netLeft").textContent = "Connecting...";
  } else {
    netPill.style.display = "none";
    clearInterval(window.latencyInterval);
    document.getElementById("netLeft").textContent = "â€” ms";
    lastRTT = 0;
  }
}

async function callUser() {
  if (!partner) {
    showAlert("Belum ada partner yang terhubung!");
    return;
  }

  // Tampilkan modal waiting SEBELUM mulai proses call
  const waitingModal = document.getElementById("waitingModal");
  const waitingText = document.getElementById("waitingText");
  waitingText.textContent = "Menunggu " + (partner.name || "partner") + " menerima panggilan...";
  waitingModal.style.display = "grid";

  // Optional: tambah timeout kalau partner lama tidak jawab (misal 45 detik)
  window.callTm = setTimeout(() => {
    if (waitingModal.style.display === "grid") {
      waitingModal.style.display = "none";
      showAlert("Panggilan tidak dijawab dalam waktu lama. Coba lagi nanti.");
    }
  }, 45000);

  try {
    const hasMedia = await startMedia();
    if (!hasMedia) {
      waitingModal.style.display = "none";
      return;
    }

    createPeer();

    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
      console.log("Track ditambahkan:", track.kind);
    });

    socket.emit("call-user");  // kirim sinyal ke server

  } catch (err) {
    console.error("Gagal memulai panggilan:", err);
    waitingModal.style.display = "none";
    showAlert("Gagal memulai video call: " + err.message);
  }
}

socket.on("incoming-call", d => {
  document.getElementById("callerName").textContent = d.name;
  document.getElementById("incomingCall").style.display = "grid";
});

socket.on("call-accepted", async () => {
  console.log("[CALLER] Panggilan diterima oleh partner");

  // Hentikan timeout waiting (kalau masih jalan)
  clearTimeout(window.callTm);

  // Sembunyikan modal waiting
  const waitingModal = document.getElementById("waitingModal");
  if (waitingModal) {
    waitingModal.style.display = "none";
  }

  callPending = false;

  try {
    // Pastikan media lokal sudah aktif (kalau belum, mulai sekarang)
    if (!localStream) {
      const hasMedia = await startMedia();
      if (!hasMedia) {
        showAlert("Gagal mengakses kamera/mikrofon setelah panggilan diterima");
        return;
      }
    }

    // Buat atau reset peer connection
    createPeer();

    // Tambahkan semua track lokal ke peer connection
    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
      console.log("[CALLER] Track ditambahkan ke pc setelah accepted:", track.kind);
    });

    // Buat dan kirim offer (SDP) ke partner
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("[CALLER] Offer dikirim setelah accepted");

    // Tampilkan layar video call
    document.getElementById("videoScreen").style.display = "flex";
    document.getElementById("callName").textContent = partner?.name || "Partner";

    // Reset layout video (local di PIP, remote di full)
    resetVideoLayout();

    // Mulai pantau koneksi & latency (penting agar ms muncul)
    checkSignal();

    // Optional: tampilkan toast konfirmasi
    showToast("Panggilan diterima! Menghubungkan video...");

  } catch (err) {
    console.error("[CALLER] Error setelah call-accepted:", err);
    showAlert("Gagal menghubungkan video call: " + err.message);

    // Cleanup kalau gagal
    if (waitingModal) waitingModal.style.display = "none";
    document.getElementById("videoScreen").style.display = "none";
    endCall(); // panggil fungsi cleanup
  }
});

function resetVideoLayout() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = false;

  local.classList.remove("full");
  local.classList.add("pip");
  remote.classList.remove("pip");
  remote.classList.add("full");

  local.style.transform = "scaleX(-1)";  // mirror self
  remote.style.transform = "";

  local.style.zIndex = "10";
  remote.style.zIndex = "5";
}

socket.on("offer", async o => {
  if (!pc) createPeer();
  await pc.setRemoteDescription(o);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("answer", ans);
});

socket.on("answer", a => pc.setRemoteDescription(a));

socket.on("ice", c => pc?.addIceCandidate(new RTCIceCandidate(c)));

async function acceptCall() {
  document.getElementById("incomingCall").style.display = "none";

  const hasMedia = await startMedia();
  if (!hasMedia) return;

  createPeer();  // Buat peer connection baru

  // Tambahkan track lokal (audio + video) ke peer connection
  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
    console.log("Track lokal ditambahkan ke pc:", track.kind); // untuk debug
  });

  // Yang paling penting: buat dan kirim OFFER dari penerima panggilan
  try {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", offer);
    console.log("Offer dikirim dari penerima panggilan");
  } catch (err) {
    console.error("Gagal membuat offer di acceptCall:", err);
    showAlert("Gagal memulai video call: " + err.message);
    return;
  }

  // Tetap beri tahu server bahwa panggilan diterima
  socket.emit("accept-call");

  // Tampilkan layar video call
  document.getElementById("videoScreen").style.display = "flex";
  document.getElementById("callName").textContent = partner?.name || "Partner";

  // Optional: reset layout agar local video di PIP, remote di full
  resetVideoLayout();
}

function rejectCall() {
  document.getElementById("incomingCall").style.display = "none";
  socket.emit("reject-call");
}

socket.on("call-rejected", () => {
  clearTimeout(window.callTm);
  document.getElementById("waitingModal").style.display = "none";
  document.getElementById("rejectedText").textContent = `${partner?.name || "Partner"} menolak panggilan.`;
  document.getElementById("rejectedModal").style.display = "grid";
});

function endCall() {
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  document.getElementById("videoScreen").style.display = "none";
  document.getElementById("netStatus").style.display = "none";
  socket.emit("end-call");
  pc = localStream = null;
  isPipSwapped = false;
}

socket.on("end-call", endCall);

// â”€â”€â”€ PIP Swap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("localVideo").onclick = function() {
  const local  = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");

  isPipSwapped = !isPipSwapped;

  if (isPipSwapped) {
    // Local full, Remote pip
    local.classList.remove("pip");
    local.classList.add("full");
    remote.classList.remove("full");
    remote.classList.add("pip");

    local.style.transform = "scaleX(-1)";  // tetap mirror
    remote.style.transform = "";           // atau scaleX(-1) jika mau mirror remote

    showToast("Layar kamu jadi besar");
  } else {
    // Kembali default
    local.classList.remove("full");
    local.classList.add("pip");
    remote.classList.remove("pip");
    remote.classList.add("full");

    local.style.transform = "scaleX(-1)";
    remote.style.transform = "";

    showToast("Kembali ke mode normal");
  }

  local.style.zIndex  = isPipSwapped ? "5"  : "10";
  remote.style.zIndex = isPipSwapped ? "10" : "5";
};

// â”€â”€â”€ Camera Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function switchCamera() {
  if (!localStream) {
    showAlert("Kamera belum aktif");
    return;
  }

  try {
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.stop();
      localStream.removeTrack(videoTrack);
    }

    const mode = isFront ? "environment" : "user";
    isFront = !isFront;

    const newStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: mode, width: { ideal: 480 }, height: { ideal: 640 } }
    });

    const newVideoTrack = newStream.getVideoTracks()[0];
    localStream.addTrack(newVideoTrack);

    const localVideo = document.getElementById("localVideo");
    localVideo.srcObject = localStream;
    localVideo.play().catch(()=>{});

    localVideo.style.transform = isFront ? "scaleX(-1)" : "scaleX(1)";

    if (pc) {
      const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
      if (sender) await sender.replaceTrack(newVideoTrack);
    }

    showToast(`Kamera ${isFront ? "depan" : "belakang"} aktif`);
  } catch (e) {
    console.error("Gagal switch kamera:", e);
    showAlert("Gagal mengganti kamera");
  }
}

function toggleMic() {
  if (!localStream) return;
  const tr = localStream.getAudioTracks()[0];
  tr.enabled = !tr.enabled;
  document.getElementById("micBtn").className = tr.enabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill muted";
  socket.emit("media-status", { mic: tr.enabled });
}

function toggleCam() {
  if (!localStream) return;
  const tr = localStream.getVideoTracks()[0];
  tr.enabled = !tr.enabled;
  document.getElementById("camBtn").className = tr.enabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill muted";
  socket.emit("media-status", { cam: tr.enabled });
}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openProfile() {
  if (!partner) return;
  document.getElementById("profileContent").innerHTML = `
    <div><b>Nama:</b> ${partner.name}</div>
    <div><b>Umur:</b> ${partner.age}</div>
    <div><b>Gender:</b> ${partner.gender || "?"}</div>
    <div><b>Status:</b> ${partner.job || "-"}</div>
    <div><b>Server:</b> ${partner.server}</div>
  `;
  document.getElementById("profileModal").style.display = "grid";
}

function closeProfile() { document.getElementById("profileModal").style.display = "none"; }
function closeRejected() { document.getElementById("rejectedModal").style.display = "none"; }

function refreshChat() {
  document.getElementById("chat").style.display = "none";
  document.getElementById("searching").style.display = "flex";
  if (window.userData) socket.emit("join", window.userData);
}

function logout() {
  socket.disconnect();
  location.reload();
}
</script>
</body>
</html>