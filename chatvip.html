<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Komunitas</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
:root{
  --bg:#0f1419;
  --card:#1c2229;
  --accent:#1da1f2;
  --bubble:#2a2f36;
}

*{box-sizing:border-box;font-family:system-ui}
html,body{margin:0;height:100%;background:var(--bg);color:#fff}

/* ===== SCREEN ===== */
.screen{height:100%;display:flex;justify-content:center;align-items:center}
.card{
  width:90%;max-width:420px;
  background:var(--card);
  padding:24px;border-radius:20px;
  text-align:center;
}

/* ===== FORM ===== */
input,select,button{
  width:100%;padding:14px;border-radius:14px;
  border:none;margin-bottom:10px
}
input,select{background:#0f1419;color:#fff}
button{background:var(--accent);color:#fff;font-weight:600}

/* ===== STATUS ===== */
.online{color:#1fdf64}
.offline{color:#ff4d4d}

/* ===== CHAT ===== */
#chat{display:none;height:100%;flex-direction:column}
.header{
  height:56px;background:var(--card);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
}
#status{font-weight:600}
#partnerStatus{font-size:12px}

#messages{flex:1;padding:12px;overflow-y:auto}
.msg{
  max-width:75%;padding:10px 14px;
  border-radius:18px;margin-bottom:8px
}
.me{background:var(--accent);margin-left:auto}
.other{background:var(--bubble)}
.time{font-size:10px;opacity:.6;text-align:right}

/* ===== FOOTER ===== */
.footer{display:none;padding:10px;background:var(--card);gap:8px}
.footer input{flex:1;border-radius:20px}
.footer button{width:80px;border-radius:20px}

/* ===== PARTNER MODAL ===== */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;z-index:20
}
.modal-panel{
  position:absolute;right:0;top:0;
  width:80%;max-width:320px;height:100%;
  background:var(--card);padding:20px;
  animation:slide .25s ease
}
@keyframes slide{
  from{transform:translateX(100%)}
  to{transform:translateX(0)}
}
.modal-panel img{
  width:90px;height:90px;border-radius:50%;
  object-fit:cover;display:block;
  margin:20px auto;cursor:pointer
}
.close{
  position:absolute;top:10px;right:10px;
  background:none;color:#fff;font-size:18px
}

/* ===== FULLSCREEN PHOTO ===== */
#photoView{
  position:fixed;inset:0;
  background:#000;display:none;
  justify-content:center;align-items:center;
  z-index:30
}
#photoView img{max-width:100%;max-height:100%}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="screen" id="login">
  <div class="card">
    <h2>Mulai Chat</h2>
    <input id="username" placeholder="Nama">
    <input id="age" type="number" placeholder="Umur">
    <select id="gender">
      <option value="">Gender</option>
      <option>Laki-laki</option>
      <option>Perempuan</option>
    </select>
    <input id="job" placeholder="Pekerjaan">
    <select id="server">
      <option value="server1">Server 1</option>
      <option value="server2">Server 2</option>
      <option value="server3">Server 3</option>
    </select>
    <input type="file" id="photo" accept="image/*">
    <button onclick="start()">Mulai Chat</button>

    <p id="serverStatus" class="offline">üî¥ Server Offline</p>
  </div>
</div>

<!-- SEARCH -->
<div class="screen" id="search" style="display:none">
  <div class="card">
    <h2>üîç Mencari Partner...</h2>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header" onclick="openPartner()">
    <div id="status">Menghubungkan...</div>
    <div id="partnerStatus" class="offline">‚óè Offline</div>
  </div>
  <div id="messages"></div>
  <div class="footer" id="footer">
    <input id="text" placeholder="Ketik pesan..."
      onkeydown="if(event.key==='Enter')send()">
    <button onclick="send()">Kirim</button>
  </div>
</div>

<!-- PARTNER INFO -->
<div id="partnerModal" class="modal">
  <div class="modal-panel">
    <button class="close" onclick="closePartner()">‚úï</button>
    <img id="pPhoto" onclick="openPhoto()">
    <h3 id="pName"></h3>
    <p id="pAge"></p>
    <p id="pGender"></p>
    <p id="pJob"></p>
    <p id="pLocation"></p>
  </div>
</div>

<!-- FULL PHOTO -->
<div id="photoView" onclick="photoView.style.display='none'">
  <img id="fullPhoto">
</div>

<script>
const socket = io("https://chat-jsb8.onrender.com");
let partner=null;

/* ===== SERVER STATUS ===== */
socket.on("connect",()=>{
  serverStatus.innerText="üü¢ Server Online";
  serverStatus.className="online";
});
socket.on("disconnect",()=>{
  serverStatus.innerText="üî¥ Server Offline";
  serverStatus.className="offline";
});

/* ===== START ===== */
function start(){
  if(!username.value||!age.value||!gender.value||!job.value)
    return alert("Lengkapi data");

  const reader=new FileReader();
  reader.onload=()=>{
    login.style.display="none";
    search.style.display="flex";

    socket.emit("join",{
      name:username.value,
      age:age.value,
      gender:gender.value,
      job:job.value,
      server:server.value,
      photo:reader.result,
      location:""
    });
  };
  photo.files[0]?reader.readAsDataURL(photo.files[0]):reader.onload();
}

/* ===== MATCH ===== */
socket.on("matched", p=>{
  partner=p;
  search.style.display="none";
  chat.style.display="flex";
  footer.style.display="flex";

  status.innerText="Chat dengan "+p.name;
  partnerStatus.innerText="‚óè Online";
  partnerStatus.className="online";
});

/* ===== MESSAGE ===== */
socket.on("message", m=>{
  if(m.text.includes("keluar")){
    partnerStatus.innerText="‚óè Offline";
    partnerStatus.className="offline";
  }
  addMsg(m.text,"other",m.time);
});

function send(){
  if(!text.value.trim())return;
  socket.emit("message",text.value);
  addMsg(text.value,"me",timeNow());
  text.value="";
}

function addMsg(t,s,ti){
  const d=document.createElement("div");
  d.className="msg "+s;
  d.innerHTML=t+`<div class="time">${ti}</div>`;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

/* ===== PARTNER INFO ===== */
function openPartner(){
  if(!partner)return;
  pPhoto.src=partner.photo||"";
  pName.innerText=partner.name;
  pAge.innerText="Umur: "+partner.age;
  pGender.innerText="Gender: "+partner.gender;
  pJob.innerText="Pekerjaan: "+partner.job;
  pLocation.innerText="Lokasi: "+(partner.location||"-");
  partnerModal.style.display="block";
}
function closePartner(){partnerModal.style.display="none"}
partnerModal.onclick=e=>{
  if(e.target===partnerModal)closePartner();
}

/* ===== FULL PHOTO ===== */
function openPhoto(){
  fullPhoto.src=partner.photo;
  photoView.style.display="flex";
}

function timeNow(){
  const d=new Date();
  return d.getHours().toString().padStart(2,"0")+":"+
         d.getMinutes().toString().padStart(2,"0");
}
</script>

</body>
</html>
