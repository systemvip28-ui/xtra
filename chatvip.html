<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Chat Komunitas</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
html,body{
  height:100%;
  background:#0f1419;
  overflow:hidden;
}

/* ===== LOGIN ===== */
#login{
  height:100%;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
#login h3{color:#fff;margin-bottom:10px}

input,select,button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-size:15px;
}
input,select{
  background:#1c2229;
  color:#fff;
}
button{
  background:#1da1f2;
  color:#fff;
  font-weight:600;
}

/* ===== CHAT APP ===== */
#chat{
  display:none;
  height:100%;
  width:100%;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header{
  flex-shrink:0;
  height:56px;
  background:#1c2229;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  font-size:16px;
}

/* MESSAGES */
#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  background:#0f1419;
}

/* MESSAGE */
.msg{
  max-width:75%;
  padding:10px 12px;
  border-radius:14px;
  margin:6px 0;
  font-size:14px;
  line-height:1.4;
  word-wrap:break-word;
}
.me{
  background:#1da1f2;
  margin-left:auto;
}
.other{
  background:#2a2f36;
}
.time{
  font-size:10px;
  opacity:.6;
  text-align:right;
  margin-top:4px;
}

/* INPUT AREA (FIXED) */
.footer{
  flex-shrink:0;
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px;
  background:#1c2229;
}
.footer input{
  flex:1;
  padding:12px 14px;
  border-radius:20px;
}
.footer button{
  width:72px;
  padding:12px 0;
  border-radius:20px;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.modal-box{
  width:85%;
  background:#1c2229;
  border-radius:16px;
  padding:20px;
  text-align:center;
  color:#fff;
}
.modal-box img{
  width:90px;
  height:90px;
  border-radius:50%;
  object-fit:cover;
  margin-bottom:10px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h3>Masuk Chat</h3>

  <input id="username" placeholder="Nama">
  <input id="age" type="number" placeholder="Umur">

  <select id="gender">
    <option value="">Pilih Gender</option>
    <option>Laki-laki</option>
    <option>Perempuan</option>
  </select>

  <input id="job" placeholder="Pekerjaan">

  <select id="server">
    <option value="server1">Server 1</option>
    <option value="server2">Server 2</option>
    <option value="server3">Server 3</option>
  </select>

  <input type="file" id="photo" accept="image/*">

  <button onclick="start()">Mulai Chat</button>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header" onclick="openPartnerInfo()">
    <span id="status">Menghubungkan...</span>
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input id="text" placeholder="Ketik pesan..." disabled
      onkeydown="if(event.key==='Enter')send()">
    <button id="sendBtn" onclick="send()" disabled>Kirim</button>
  </div>
</div>

<!-- INFO MODAL -->
<div class="modal" id="partnerModal">
  <div class="modal-box">
    <img id="pPhoto">
    <h4 id="pName"></h4>
    <p id="pAge"></p>
    <p id="pGender"></p>
    <p id="pJob"></p>
    <p id="pLocation"></p>
    <button onclick="partnerModal.style.display='none'">Tutup</button>
  </div>
</div>

<script>
const socket = io("https://chat-jsb8.onrender.com"); // GANTI
let partner=null, locationText="";

/* LOCATION */
navigator.geolocation?.getCurrentPosition(p=>{
  locationText = p.coords.latitude.toFixed(3)+","+p.coords.longitude.toFixed(3);
});

/* START */
function start(){
  if(!username.value||!age.value||!gender.value||!job.value){
    alert("Lengkapi data");
    return;
  }

  const reader = new FileReader();
  reader.onload = ()=>{
    login.style.display="none";
    chat.style.display="flex";

    socket.emit("join",{
      name:username.value,
      age:age.value,
      gender:gender.value,
      job:job.value,
      server:server.value,
      photo:reader.result,
      location:locationText
    });
  };
  if(photo.files[0]) reader.readAsDataURL(photo.files[0]);
  else reader.onload();
}

/* MATCH */
socket.on("matched",p=>{
  partner=p;
  status.innerText=p.name;
  text.disabled=false;
  sendBtn.disabled=false;
});

/* MESSAGE */
socket.on("message",m=>{
  addMsg(m.text,"other",m.time);
});

function send(){
  const msg=text.value.trim();
  if(!msg)return;
  socket.emit("message",msg);
  addMsg(msg,"me",timeNow());
  text.value="";
}

function addMsg(t,s,ti){
  const d=document.createElement("div");
  d.className="msg "+s;
  d.innerHTML=t+`<div class="time">${ti}</div>`;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

function openPartnerInfo(){
  if(!partner)return;
  pPhoto.src=partner.photo||"";
  pName.innerText=partner.name;
  pAge.innerText="Umur: "+partner.age;
  pGender.innerText="Gender: "+partner.gender;
  pJob.innerText="Pekerjaan: "+partner.job;
  pLocation.innerText="Lokasi: "+(partner.location||"-");
  partnerModal.style.display="flex";
}

function timeNow(){
  const d=new Date();
  return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
}
</script>

</body>
</html>
