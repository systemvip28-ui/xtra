<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Komunitas</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
  --bg:#0b141a;
  --card:#202c33;
  --me:#005c4b;
  --other:#1f2c33;
  --accent:#00a884;
  --text:#e9edef;
}
*{box-sizing:border-box;font-family:system-ui}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text)}

.screen{height:100%;display:flex;justify-content:center;align-items:center}
.card{width:90%;max-width:420px;background:var(--card);padding:24px;border-radius:20px}

input,select,button{width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px}
input,select{background:#0b141a;color:#fff}
button{background:var(--accent);color:#fff;font-weight:600}

/* CHAT */
#chat{display:none;height:100%;flex-direction:column}
.header{
  height:56px;background:var(--card);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;
}
.title{display:flex;flex-direction:column}
#typing{font-size:12px;opacity:.6}
.icons i{font-size:20px;margin-left:14px;cursor:pointer}

/* MESSAGES */
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{max-width:78%;margin-bottom:8px;font-size:14px}
.me{margin-left:auto}
.bubble{
  padding:8px 12px;border-radius:8px;
}
.me .bubble{background:var(--me);border-top-right-radius:0}
.other .bubble{background:var(--other);border-top-left-radius:0}
.time{font-size:10px;opacity:.5;text-align:right;margin-top:2px}

/* IMAGE CHAT */
.chat-img{
  max-width:200px;
  border-radius:8px;
  cursor:pointer;
}

/* FOOTER */
.footer{padding:8px;background:var(--card);display:flex;gap:6px}
.footer input[type=text]{flex:1;border-radius:20px}
.footer button{width:44px;border-radius:50%}

/* RANGE */
.range-wrap{
  text-align:left;
  font-size:14px;
  margin-bottom:10px;
}
.range-wrap span{float:right}

/* MODAL IMAGE */
#imgView{
  position:fixed;inset:0;
  background:#000;
  display:none;
  justify-content:center;
  align-items:center;
}
#imgView img{max-width:100%;max-height:100%}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="screen" id="login">
  <div class="card">
    <input id="username" placeholder="Nama">

    <div class="range-wrap">
      Umur: <span id="ageVal">21</span>
      <input id="age" type="range" min="16" max="30" value="21"
        oninput="ageVal.innerText=this.value">
    </div>

    <select id="gender">
      <option value="">Gender</option>
      <option>Laki-laki</option>
      <option>Perempuan</option>
    </select>

    <select id="job">
      <option value="">Pekerjaan</option>
      <option>Sekolah</option>
      <option>Kerja</option>
      <option>Pengangguran</option>
    </select>

    <select id="server">
      <option value="server1">Server 1</option>
      <option value="server2">Server 2</option>
      <option value="server3">Server 3</option>
    </select>

    <button onclick="start()">Mulai Chat</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header">
    <div class="title">
      <div id="status">Menghubungkan...</div>
      <div id="typing"></div>
    </div>
    <div class="icons">
      <i class="bi bi-info-circle"></i>
      <i class="bi bi-box-arrow-right" onclick="logout()"></i>
    </div>
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input type="file" id="imgInput" accept="image/*" hidden>
    <button onclick="imgInput.click()">ðŸ“Ž</button>
    <input id="text" type="text" placeholder="Pesan..."
      oninput="typingEmit()"
      onkeydown="if(event.key==='Enter')sendText()">
    <button onclick="sendText()">âž¤</button>
  </div>
</div>

<!-- IMAGE VIEW -->
<div id="imgView" onclick="this.style.display='none'">
  <img id="fullImg">
</div>

<script>
const socket = io("https://chat-jsb8.onrender.com",{reconnection:true});
let partner=null, typingTimer=null;

/* RESTORE */
if(localStorage.inChat){
  login.style.display="none";
  chat.style.display="flex";
  partner=JSON.parse(localStorage.chatPartner);
  status.innerText="Chat dengan "+partner.name;
}

/* START */
function start(){
  const user={
    name:username.value,
    age:age.value,
    gender:gender.value,
    job:job.value,
    server:server.value
  };
  localStorage.chatUser=JSON.stringify(user);
  socket.emit("join",user);
  login.style.display="none";
  chat.style.display="flex";
}

/* MATCH */
socket.on("matched",p=>{
  partner=p;
  localStorage.chatPartner=JSON.stringify(p);
  localStorage.inChat=true;
  status.innerText="Chat dengan "+p.name;
});

/* TEXT MESSAGE */
socket.on("message",m=>{
  if(m.type==="text") addText(m.text,"other",m.time);
  if(m.type==="image") addImage(m.src,"other",m.time);
  typing.innerText="";
});

/* TYPING */
function typingEmit(){
  socket.emit("typing");
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>socket.emit("stopTyping"),800);
}
socket.on("typing",()=>typing.innerText="mengetik...");
socket.on("stopTyping",()=>typing.innerText="");

/* SEND TEXT */
function sendText(){
  if(!text.value.trim())return;
  socket.emit("message",{type:"text",text:text.value});
  addText(text.value,"me",timeNow());
  text.value="";
  socket.emit("stopTyping");
}

/* SEND IMAGE */
imgInput.onchange=()=>{
  const r=new FileReader();
  r.onload=()=>{
    socket.emit("message",{type:"image",src:r.result});
    addImage(r.result,"me",timeNow());
  };
  r.readAsDataURL(imgInput.files[0]);
};

/* UI */
function addText(t,s,ti){
  messages.insertAdjacentHTML("beforeend",
    `<div class="msg ${s}">
      <div class="bubble">${t}</div>
      <div class="time">${ti}</div>
    </div>`);
  messages.scrollTop=messages.scrollHeight;
}
function addImage(src,s,ti){
  messages.insertAdjacentHTML("beforeend",
    `<div class="msg ${s}">
      <div class="bubble">
        <img src="${src}" class="chat-img" onclick="viewImg(this.src)">
      </div>
      <div class="time">${ti}</div>
    </div>`);
  messages.scrollTop=messages.scrollHeight;
}
function viewImg(src){
  fullImg.src=src;
  imgView.style.display="flex";
}
function timeNow(){
  const d=new Date();
  return d.getHours().toString().padStart(2,"0")+":"+
         d.getMinutes().toString().padStart(2,"0");
}

/* LOGOUT */
function logout(){
  localStorage.clear();
  location.reload();
}
</script>

</body>
</html>
